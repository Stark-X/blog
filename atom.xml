<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Stark-X&#39;s Blog</title>
  
  <subtitle>Beneath this blog there is an idea</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://blog.stark-x.cn/"/>
  <updated>2019-03-05T13:05:00.000Z</updated>
  <id>https://blog.stark-x.cn/</id>
  
  <author>
    <name>Stark-X</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>使用Kubeadm, Vagrant, Virtualbox部署本地Kubernetes集群 - TL;DR</title>
    <link href="https://blog.stark-x.cn/2019/03/04/local-kubernetes-cluster-with-kubeadm-vagrant-and-virtualbox-tldr/"/>
    <id>https://blog.stark-x.cn/2019/03/04/local-kubernetes-cluster-with-kubeadm-vagrant-and-virtualbox-tldr/</id>
    <published>2019-03-04T15:25:14.000Z</published>
    <updated>2019-03-05T13:05:00.000Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><!-- Description to show on index here  --><p>本文章是上一篇文章「<a href="/2018/11/14/Local-kubernetes-cluster-with-kubeadm-vagrant-and-virtualbox/" title="使用Kubeadm, Vagrant, Virtualbox部署本地Kubernetes集群">使用Kubeadm, Vagrant, Virtualbox部署本地Kubernetes集群</a>」的 TL;DR 版本。</p><h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><ul><li>启动两个虚拟机，一个作为主节点，一个作为工作节点</li><li>熟悉 Kubeadm</li><li>在集群上部署Kubernetes-dashboard、nginx</li></ul><a id="more"></a><h1 id="环境相关"><a href="#环境相关" class="headerlink" title="环境相关"></a>环境相关</h1><ul><li>操作系统：macOS Mojave 10.14.3 (18D109)</li><li>编排工具：Vagrant 2.2.3 </li><li>虚拟机：Virtualbox 6.0</li><li>可变参数：注意所有替换文中所有的${xxx}为自己环境的值</li></ul><h1 id="实验环境设计"><a href="#实验环境设计" class="headerlink" title="实验环境设计"></a>实验环境设计</h1><p>使用 Vagrant 配合 Virtualbox 建立两个节点模拟集群，一个作为 master node，一个作为 work node。</p><h2 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h2><ul><li>master:<ul><li>network:<ul><li>8001:8001/tcp</li><li>80:10000/tcp</li></ul></li></ul></li><li>worker:<ul><li>network:<ul><li>80:10001/tcp</li></ul></li></ul></li><li>master &amp; worker:<ul><li>OS: Ubuntu/xenial64</li><li>CPU: 2 core</li><li>MEM: 2 GB</li><li>network:<ul><li>iface x 2: NAT &amp; Host-Only</li></ul></li><li>dependencies:<ul><li>kubelet</li><li>kubectl</li><li>kubeadm</li><li>docker</li></ul></li></ul></li></ul><h2 id="Vagrantfile"><a href="#Vagrantfile" class="headerlink" title="Vagrantfile"></a>Vagrantfile</h2><figure class="highlight ruby"><figcaption><span>Vagrantfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">$script = <span class="string">&lt;&lt;-SCRIPT</span></span><br><span class="line"><span class="string">echo "Update and install the kubeadm"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">apt-get update &amp;&amp; apt-get install -y apt-transport-https curl</span></span><br><span class="line"><span class="string">curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -</span></span><br><span class="line"><span class="string">cat &lt;&lt;EOF &gt;/etc/apt/sources.list.d/kubernetes.list</span></span><br><span class="line"><span class="string">deb https://apt.kubernetes.io/ kubernetes-xenial main</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y kubelet kubeadm kubectl docker.io</span><br><span class="line">apt-mark hold kubelet kubeadm kubectl</span><br><span class="line">usermod -aG docker vagrant</span><br><span class="line">kubeadm config images pull</span><br><span class="line">SCRIPT</span><br><span class="line"></span><br><span class="line">Vagrant.configure(<span class="string">"2"</span>) <span class="keyword">do</span> <span class="params">|config|</span></span><br><span class="line">  config.vm.provider <span class="string">"virtualbox"</span> <span class="keyword">do</span> <span class="params">|v|</span></span><br><span class="line">    v.memory = <span class="number">2048</span></span><br><span class="line">    v.cpus = <span class="number">2</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">  config.vm.define <span class="string">"master"</span>, <span class="symbol">primary:</span> <span class="literal">true</span> <span class="keyword">do</span> <span class="params">|master|</span></span><br><span class="line">    master.vm.hostname = <span class="string">"k8s-cluster-master"</span></span><br><span class="line">    master.vm.box = <span class="string">"ubuntu/xenial64"</span></span><br><span class="line">    master.vm.network <span class="string">"forwarded_port"</span>, <span class="symbol">guest:</span> <span class="number">80</span>, <span class="symbol">host:</span> <span class="number">10000</span>, <span class="symbol">protocol:</span> <span class="string">"tcp"</span></span><br><span class="line">    master.vm.network <span class="string">"forwarded_port"</span>, <span class="symbol">guest:</span> <span class="number">8001</span>, <span class="symbol">host:</span> <span class="number">8001</span>, <span class="symbol">protocol:</span> <span class="string">"tcp"</span></span><br><span class="line">    master.vm.network <span class="string">"private_network"</span>, <span class="symbol">type:</span> <span class="string">"dhcp"</span></span><br><span class="line">    master.vm.provision <span class="string">"shell"</span>, <span class="symbol">inline:</span> $script</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  config.vm.define <span class="string">"node"</span> <span class="keyword">do</span> <span class="params">|node|</span></span><br><span class="line">    node.vm.hostname = <span class="string">"k8s-cluster-node"</span></span><br><span class="line">    node.vm.box = <span class="string">"ubuntu/xenial64"</span></span><br><span class="line">    node.vm.network <span class="string">"forwarded_port"</span>, <span class="symbol">guest:</span> <span class="number">80</span>, <span class="symbol">host:</span> <span class="number">10001</span>, <span class="symbol">protocol:</span> <span class="string">"tcp"</span></span><br><span class="line">    node.vm.network <span class="string">"private_network"</span>, <span class="symbol">type:</span> <span class="string">"dhcp"</span></span><br><span class="line">    node.vm.provision <span class="string">"shell"</span>, <span class="symbol">inline:</span> $script</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h2 id="启动节点"><a href="#启动节点" class="headerlink" title="启动节点"></a>启动节点</h2><p>执行命令<code>vagrant up</code>，Vagrant 开始自动下载Ubuntu镜像，顺利启动后，vagrant 会执行我们写在<code>Vagrantfile</code>里的 Shell 脚本。初始化完成后，在当前窗口执行<code>vagrant ssh master</code>，新开一个窗口执行<code>vagrant ssh node</code>分别 ssh 进入到主节点以及工作节点。<br><img src="http://img-cdn.xjztest.com/20190305142616-vagrant_up.png-watermark_compress" alt="vagrant up"><em><small>第一次执行<code>vagrant up</code>会看到更多的信息。</small></em></p><p>使用命令<code>ip a</code>查看当前节点 ip，两个节点互相 ping，检查连通性。</p><h1 id="部署-Kubernetes-集群"><a href="#部署-Kubernetes-集群" class="headerlink" title="部署 Kubernetes 集群"></a>部署 Kubernetes 集群</h1><p>根据上述 Vagrantfile 创建出来的虚拟机各有两个网卡，第一个是 NAT 模式，第二个是 Host-Only 模式，而 Kubernetes nodes 节点间通讯应该通过第二个网卡，所以选择了 <em>flannel</em> 作为 <a href="https://kubernetes.io/docs/concepts/cluster-administration/addons/" target="_blank" rel="noopener">CNI 插件</a>，因为它可以指定用于节点间通讯的网卡 (iface)(<a href="https://github.com/coreos/flannel/blob/master/Documentation/troubleshooting.md#vagrant" target="_blank" rel="noopener">原因</a>)。</p><p>参考<a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/" target="_blank" rel="noopener">官方文档</a>，步骤如下：</p><ol><li><p>获取 <em>flannel</em> 的 yaml 文件，修改系统参数，并修改 iface 使用第二个网卡。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">wget https://github.com/coreos/flannel/blob/master/Documentation/kube-flannel.yml</span><br><span class="line"><span class="comment"># 找到image tag是-amd64结尾的/opt/bin/flanneld，在下面的args列表添加 - --iface 以及 - enp0s8 这两行</span></span><br><span class="line"><span class="comment"># vim kube-flannel.md</span></span><br></pre></td></tr></table></figure></li><li><p>在主节点 <em>k8s-cluster-master</em> 执行<code>sudo kubeadm init --apiserver-advertise-address=${ip} --pod-network-cidr=10.244.0.0/16</code>初始化节点，成功后，根据 kubeadm 的输出，执行接下来的命令。</p></li><li><p>复制 kubeadm 生成的配置文件，更改配置文件夹的权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure></li><li><p>启动 CNI 插件 <em>flannel</em></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kube-flannel.yml</span><br></pre></td></tr></table></figure></li><li><p>把下面 shell 脚本保存为 “change-kubelet-node-ip.sh”，并执行</p><figure class="highlight bash"><figcaption><span>change-kubelet-node-ip.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">COND_NODE_IP=`grep node-ip /var/lib/kubelet/kubeadm-flags.env | wc -l`</span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$&#123;COND_NODE_IP&#125;</span> = 1 ]]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"--node-ip had been set, skipped"</span></span><br><span class="line">  <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">sudo sed -i <span class="string">'/^.*/ s/$/ --node-ip=$&#123;ip&#125;/'</span> /var/lib/kubelet/kubeadm-flags.env</span><br><span class="line">sudo systemctl restart kubelet</span><br></pre></td></tr></table></figure></li><li><p>在 worker节点执行如下脚本，把 worker 节点加入到 Kubernetes 集群</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join <span class="variable">$&#123;master_ip&#125;</span>:6443 --token <span class="variable">$&#123;token&#125;</span> --discovery-token-ca-cert-hash sha256:<span class="variable">$&#123;hash&#125;</span> --apiserver-advertise-address=<span class="variable">$&#123;worker_ip&#125;</span></span><br></pre></td></tr></table></figure></li><li><p>在 worker 节点同样运行上述的 “change-kubelet-node-ip.sh”，注意修改脚本里的 ip地址为 worker 节点的 ip。</p></li><li>查看节点状态，Pods 状态</li></ol><p><img src="http://img-cdn.xjztest.com/20190305154528-get_pods_nodes-master.png-watermark_compress" alt="Node: master | get pods, get nodes"><center><small>Node: master | get pods, get nodes</small></center></p><p><img src="http://img-cdn.xjztest.com/20190305154700-kubeadm_join-worker.png-watermark_compress" alt="Node: worker | kubeadm join"><center><small>Node: worker | kubeadm join</small></center></p><h1 id="部署-Kubernetes-Dashboard"><a href="#部署-Kubernetes-Dashboard" class="headerlink" title="部署 Kubernetes Dashboard"></a>部署 Kubernetes Dashboard</h1><ol><li>从<a href="https://github.com/kubernetes/dashboard" target="_blank" rel="noopener">Kubernetes Dashboard Repo</a>获取部署命令，部署 dashboard。</li><li>查看 pods 状态，直到相关 pods 处于 running 状态。</li><li>启动 Kubenetes Proxy。 </li><li>通过 proxy 访问 Dashboard: <a href="http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/" target="_blank" rel="noopener">http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/</a> 。(Kubernetes Proxy 是一个反向代理，把外部请求通过主节点/集群，转发到工作节点/集群，避免直接暴露服务，降低安全风险)</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml</span><br><span class="line">kubectl get pods -n kube-system</span><br><span class="line">kubectl proxy --address 0.0.0.0</span><br></pre></td></tr></table></figure><p><img src="http://img-cdn.xjztest.com/20190305160256-kubernetes_dashboard-master.png-watermark_compress" alt="Node: master | Kubernetes dashboard"><center><small>Node: master | Kubernetes dashboard</small></center></p><p><img src="http://img-cdn.xjztest.com/20190305160831-Kubernetes_dashboard-access.png-watermark_compress" alt="Kubernetes Dashboard Login"> <center><small>Kubernetes Dashboard Login</small></center></p><h1 id="部署-Nginx"><a href="#部署-Nginx" class="headerlink" title="部署 Nginx"></a>部署 Nginx</h1><p>编写一个 yaml 文件，部署两个 NGINX instance 到集群。</p><h2 id="nginx-rs-yaml"><a href="#nginx-rs-yaml" class="headerlink" title="nginx-rs.yaml"></a>nginx-rs.yaml</h2><p>保存下面的yaml，命名为 “nginx-rs.yaml”。</p><figure class="highlight yaml"><figcaption><span>nginx-rs.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    svc:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">9999</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  revisionHistoryLimit:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      svc:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        svc:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">          - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">            protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure><h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi nginx-rs.yaml</span></span><br><span class="line">kubectl apply -f nginx-rs.yaml</span><br><span class="line">kubectl get pods</span><br><span class="line">kubectl proxy --address 0.0.0.0</span><br></pre></td></tr></table></figure><p>在宿主机打开 <a href="http://localhost:8001/api/v1/namespaces/default/services/nginx/proxy/" target="_blank" rel="noopener">http://localhost:8001/api/v1/namespaces/default/services/nginx/proxy/</a> 即可看到熟悉的 NGINX 默认首页。(<a href="https://kubernetes.io/zh/docs/tasks/access-application-cluster/access-cluster/#%E6%89%8B%E5%8A%A8%E6%9E%84%E5%BB%BA-apiserver-%E4%BB%A3%E7%90%86-url" target="_blank" rel="noopener">Kubernetes proxy URL 规则</a>)</p><p><img src="http://img-cdn.xjztest.com/20190305162916-kubernetes_nginx.png-watermark_compress" alt="Nginx via Kubernetes proxy"> <center><small>Nginx via Kubernetes proxy</small></center></p><h1 id="完"><a href="#完" class="headerlink" title="完"></a>完</h1><p>此篇文章省略了在实验期间踩过的大量的坑，如果跟着我的流程下来遇到了什么问题可以先查看上一篇文章「<a href="/2018/11/14/Local-kubernetes-cluster-with-kubeadm-vagrant-and-virtualbox/" title="使用Kubeadm, Vagrant, Virtualbox部署本地Kubernetes集群">使用Kubeadm, Vagrant, Virtualbox部署本地Kubernetes集群</a>」，可能你会找到答案，或者在下方留言评论。</p>]]></content>
    
    <summary type="html">
    
      &lt;!-- toc --&gt;
&lt;!-- Description to show on index here  --&gt;
&lt;p&gt;本文章是上一篇文章「&lt;a href=&quot;/2018/11/14/Local-kubernetes-cluster-with-kubeadm-vagrant-and-virtualbox/&quot; title=&quot;使用Kubeadm, Vagrant, Virtualbox部署本地Kubernetes集群&quot;&gt;使用Kubeadm, Vagrant, Virtualbox部署本地Kubernetes集群&lt;/a&gt;」的 TL;DR 版本。&lt;/p&gt;
&lt;h1 id=&quot;目标&quot;&gt;&lt;a href=&quot;#目标&quot; class=&quot;headerlink&quot; title=&quot;目标&quot;&gt;&lt;/a&gt;目标&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;启动两个虚拟机，一个作为主节点，一个作为工作节点&lt;/li&gt;
&lt;li&gt;熟悉 Kubeadm&lt;/li&gt;
&lt;li&gt;在集群上部署Kubernetes-dashboard、nginx&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="Solutions" scheme="https://blog.stark-x.cn/categories/Solutions/"/>
    
    
      <category term="Ops" scheme="https://blog.stark-x.cn/tags/Ops/"/>
    
      <category term="Kubernetes" scheme="https://blog.stark-x.cn/tags/Kubernetes/"/>
    
      <category term="Vagrant" scheme="https://blog.stark-x.cn/tags/Vagrant/"/>
    
  </entry>
  
  <entry>
    <title>使用Kubeadm, Vagrant, Virtualbox部署本地Kubernetes集群</title>
    <link href="https://blog.stark-x.cn/2018/11/14/Local-kubernetes-cluster-with-kubeadm-vagrant-and-virtualbox/"/>
    <id>https://blog.stark-x.cn/2018/11/14/Local-kubernetes-cluster-with-kubeadm-vagrant-and-virtualbox/</id>
    <published>2018-11-14T12:09:31.000Z</published>
    <updated>2019-03-05T08:46:21.213Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><!-- Description to show on index here  --><p>在前一阵子参加了DevOps国际峰会(DevOps International Summit)，《DevOps Handbook》和《Beyond The Phoenix Project》的联合作者 John Willis 在他的分享中提出了“Kubernetes将成为未来的主流”，再加上我所在公司有大量的微服务架构项目使用到了Kubernetes，遂开始学习Kubernetes。<br>那要去学习它就必须得有可操作环境，在<a href="https://kubernetes.io/docs/setup/pick-right-solution/#local-machine-solutions" target="_blank" rel="noopener">Kubernetes官网</a>提供了好多个解决方案。</p><p>我选择了难度稍高的 kubeadm 配合由 Vagrant 以及 Virtualbox 搭建的虚拟机创建 Kubernetes 的集群，通过使用 kubeadm 熟悉 Kubernetes 的部署流程以及它的原理。</p><h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><ul><li>启动两个虚拟机，一个作为主节点，一个作为工作节点</li><li>熟悉 Kubeadm</li><li>在集群上部署Kubernetes-dashboard、nginx<a id="more"></a></li></ul><h1 id="开工"><a href="#开工" class="headerlink" title="开工"></a>开工</h1><p>我使用MacOS作为运行环境写的这篇文章，在其它操作系统上进行操作可能会有一点不一样。另外，因为 Kubernetes 的镜像在谷歌的服务器，总所周知的原因，请先架好梯子，否则会出现下载不了镜像等“正常”现象。<br><em><small>梯子方面优先选择付费服务，可以减少你大量的工作。</small></em></p><h2 id="编写-Vagrantfile"><a href="#编写-Vagrantfile" class="headerlink" title="编写 Vagrantfile"></a>编写 Vagrantfile</h2><p>要在本地建立集群，那就先建两个虚拟机吧，这两个虚拟机配置、设定上应该是基本一致的，那就使用 Vagrant 做初始化，环境配置。使用 Vagrant 的一大好处是只需要一份<code>Vagrantfile</code>就可以保证使用它建立起来的虚拟机是一致的，并且自动地把下载镜像、初始化、配置等等全做好了。</p><p>既然是个集群，那它们之间应该可以相互通讯，需要配置一个私有网络；另外，Vagrant 默认创建的网络是 NAT 模式，那要有端口映射，预留端口 10000-&gt;80(master)，10001-&gt;80(node)；根据<a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/#before-you-begin" target="_blank" rel="noopener">官网的介绍</a>，所有节点推荐使用至少2核CPU，2G内存；同样根据<a href="https://kubernetes.io/docs/setup/independent/install-kubeadm/#installing-kubeadm-kubelet-and-kubectl" target="_blank" rel="noopener">官方文档</a>，需要安装 kubelet，kubectl，kubeadm，docker。根据这些条件，就有了下面的<code>Vagrantfile</code>。</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$script = <span class="string">&lt;&lt;-SCRIPT</span></span><br><span class="line"><span class="string">echo "Update and install the kubeadm"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">apt-get update &amp;&amp; apt-get install -y apt-transport-https curl</span></span><br><span class="line"><span class="string">curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -</span></span><br><span class="line"><span class="string">cat &lt;&lt;EOF &gt;/etc/apt/sources.list.d/kubernetes.list</span></span><br><span class="line"><span class="string">deb https://apt.kubernetes.io/ kubernetes-xenial main</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y kubelet kubeadm kubectl docker.io</span><br><span class="line">apt-mark hold kubelet kubeadm kubectl</span><br><span class="line">usermod -aG docker vagrant</span><br><span class="line">kubeadm config images pull</span><br><span class="line">SCRIPT</span><br><span class="line"></span><br><span class="line">Vagrant.configure(<span class="string">"2"</span>) <span class="keyword">do</span> <span class="params">|config|</span></span><br><span class="line">  config.vm.provider <span class="string">"virtualbox"</span> <span class="keyword">do</span> <span class="params">|v|</span></span><br><span class="line">    v.memory = <span class="number">2048</span></span><br><span class="line">    v.cpus = <span class="number">2</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  </span><br><span class="line">  config.vm.define <span class="string">"master"</span>, <span class="symbol">primary:</span> <span class="literal">true</span> <span class="keyword">do</span> <span class="params">|master|</span></span><br><span class="line">    master.vm.hostname = <span class="string">"k8s-cluster-master"</span></span><br><span class="line">    master.vm.box = <span class="string">"ubuntu/xenial64"</span></span><br><span class="line">    master.vm.network <span class="string">"forwarded_port"</span>, <span class="symbol">guest:</span> <span class="number">80</span>, <span class="symbol">host:</span> <span class="number">10000</span>, <span class="symbol">protocol:</span> <span class="string">"tcp"</span></span><br><span class="line">    master.vm.network <span class="string">"private_network"</span>, <span class="symbol">type:</span> <span class="string">"dhcp"</span></span><br><span class="line">    master.vm.provision <span class="string">"shell"</span>, <span class="symbol">inline:</span> $script</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  config.vm.define <span class="string">"node"</span> <span class="keyword">do</span> <span class="params">|node|</span></span><br><span class="line">    node.vm.hostname = <span class="string">"k8s-cluster-node"</span></span><br><span class="line">    node.vm.box = <span class="string">"ubuntu/xenial64"</span></span><br><span class="line">    node.vm.network <span class="string">"forwarded_port"</span>, <span class="symbol">guest:</span> <span class="number">80</span>, <span class="symbol">host:</span> <span class="number">10001</span>, <span class="symbol">protocol:</span> <span class="string">"tcp"</span></span><br><span class="line">    node.vm.network <span class="string">"private_network"</span>, <span class="symbol">type:</span> <span class="string">"dhcp"</span></span><br><span class="line">    node.vm.provision <span class="string">"shell"</span>, <span class="symbol">inline:</span> $script</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h2 id="启动节点"><a href="#启动节点" class="headerlink" title="启动节点"></a>启动节点</h2><p>执行命令<code>vagrant up</code>，Vagrant 开始自动下载Ubuntu镜像，并执行我们写在<code>Vagrantfile</code>里的 Shell 脚本，顺利启动后，在当前窗口执行<code>vagrant ssh master</code>，新开一个窗口执行<code>vagrant ssh node</code>分别 ssh 进入到主节点以及工作节点。 <img src="https://i.loli.net/2018/11/14/5bec3c9cd27ad.png" alt="vagrant"><em><small>第一次执行<code>vagrant up</code>会看到更多的信息。</small></em></p><p>使用命令<code>ip a</code>查看当前节点 ip，两个节点互相 ping，检查连通性。</p><h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><p>过程没有想象中顺利，我完全跟着官网文档操作，却陷进到一连串的坑里，耗费了接近两周的时间才把 Kubernets 集群搭建起来。</p><h2 id="Round-1-Kubernetes-集群"><a href="#Round-1-Kubernetes-集群" class="headerlink" title="Round 1 - Kubernetes 集群"></a>Round 1 - Kubernetes 集群</h2><p>我们一步一步按照<a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/" target="_blank" rel="noopener">官方文档</a>，在主节点 <em>k8s-cluster-master</em> 执行<code>sudo kubeadm init</code>初始化节点，成功后，根据 kubeadm 的输出，执行接下来的命令。</p><ul><li><p>复制 kubeadm 生成的配置文件，更改配置文件夹的权限</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure></li><li><p>选择一个<a href="https://kubernetes.io/docs/concepts/cluster-administration/addons/" target="_blank" rel="noopener">CNI 插件</a>组建网络，我们这里选择了<em>Weave Net</em></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f &quot;https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d &apos;\n&apos;)&quot;</span><br></pre></td></tr></table></figure></li><li><p>工作节点执行最后一句<code>sudo kubeadm join</code>，加入到 Kubernetes 集群</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 10.0.2.15:6443 --token &lt;token&gt; --discovery-token-ca-cert-hash sha256:&lt;hash&gt;</span><br></pre></td></tr></table></figure></li><li><p>查看节点状态，Pods 状态</p></li></ul><p><img src="https://i.loli.net/2018/11/22/5bf656dc473c4.png" alt="Node: master | get pods, get nodes"><center><small>Node: master | get pods, get nodes</small></center></p><p><img src="https://i.loli.net/2018/11/22/5bf65a6319aba.png" alt="Node: worker | kubeadm join"><center><small>Node: worker | kubeadm join</small></center></p><h3 id="Round-1-1-工作节点无法连接到主节点"><a href="#Round-1-1-工作节点无法连接到主节点" class="headerlink" title="Round 1.1 - 工作节点无法连接到主节点"></a>Round 1.1 - 工作节点无法连接到主节点</h3><p>这里遇到第一个坑，工作节点无法连接到主节点的 Kubernetes api。在工作节点的 <code>kubeadm join</code> log，我们可以看到 kubelet 在不断地尝试访问 10.0.2.15:6443，曾经看过 VirtualBox 的说明文档，默认情况下 ip 10.0.2.15 是在虚拟机在宿主机网络里的 ip，所有的虚拟机都遵循这一设定，而工作节点需要访问的是主节点的 6443 端口，现在却在尝试 10.0.2.15，相当于不断尝试连接节点自身的6443端口，这明显不对。</p><p>因此，我们需要 kubelet 访问/提供正确的节点ip，查阅文档，发现 kubeadm 有一个参数 <code>--apiserver-advertise-address=&lt;ip&gt;</code>，显式指定 kubelet api server 的 ip 地址。</p><p>好吧，执行<code>sudo kubeadm reset</code>，加上参数，重新做一遍。</p><h3 id="Round-1-2-工作节点-Not-Ready"><a href="#Round-1-2-工作节点-Not-Ready" class="headerlink" title="Round 1.2 - 工作节点 Not Ready"></a>Round 1.2 - 工作节点 Not Ready</h3><p><img src="https://i.loli.net/2018/11/22/5bf65dc1ca316.png" alt="Node: master | kubeadm init"><center><small>Node: master | kubeadm init</small></center><br><img src="https://i.loli.net/2018/11/22/5bf65d63a35f8.png" alt="Node: worker | kubeadm join"><center><small>Node: worker | kubeadm join</small></center></p><p>执行成功，但是当我们在主节点执行<code>kubectl get nodes</code>, <code>kubectl get pods -n kube-system</code>，可以看到 node: NotReady，weave 的 Pods 一直处于 CrashLoopBackOff 状态(这表示 Pod 创建失败，kubelet 在不断地重试)，在工作节点查看 docker logs 发现 weave 一直在尝试连接 10.96.0.1:443，但是根据 docker logs 显示，以及通过 ping，telnet 检测，全 timeout，目标不可达。<br><img src="https://i.loli.net/2018/11/22/5bf661e18052d.png" alt="Node: master | get nodes, get pods"><center><small>Node: master | get nodes, get pods</small></center></p><p><img src="https://i.loli.net/2018/11/22/5bf6691bcb58c.png" alt="Node: worker | logs"><center><small>Node: worker | logs</small></center></p><p>这个 ip 地址理应是 Kubernetes 提供的，经过一番查找，在 Services 里找到了这个 ip，<code>kubectl get svc</code>，可以看到返回结果表明 10.96.0.1 是 Kubernetes 本身在集群里的 ip。</p><p>不科学啊，节点之间是通的，难道是 CNI 插件有问题？换一个试试，在官网的教程里有好几个其它插件供选择，这次我选择了 <em>flannel</em>，跟 <em>Weave Net</em> 不太一样的是，它需要在 init 的时候加上一个额外的参数<code>--pod-network-cidr=10.244.0.0/16</code>，net.bridge.bridge-nf-call-iptables 必须设为 1，reset 集群，重新执行命令部署。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sysctl net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">sudo kubeadm init --apiserver-advertise-address 172.28.128.3 --pod-network-cidr=10.244.0.0/16</span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/bc79dd1505b0c8681ece4de4c0d86c5cd2643275/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo kubeadm join 172.28.128.3:6443 --token 4puk29.w2ur96jtfuu9z22v --discovery-token-ca-cert-hash sha256:3973ee67977702c144f6f57613f8ce7765eac975990520846a15465fac625043 --apiserver-advertise-address 172.28.128.4</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2018/11/22/5bf673fe2a2b2.png" alt="Node: master | get nodes, get pods"><center><small>Node: master | get nodes, get pods</small></center><br>这次一切都很顺利，<code>kubectl get nodes</code>显示节点 ready，<code>kubectl get pods -n kube-system</code>显示所有 Pods 运行正常，great! </p><h2 id="Round-2-Kubernetes-Dashboard"><a href="#Round-2-Kubernetes-Dashboard" class="headerlink" title="Round 2 - Kubernetes Dashboard"></a>Round 2 - Kubernetes Dashboard</h2><p>从<a href="https://github.com/kubernetes/dashboard" target="_blank" rel="noopener">Kubernetes Dashboard Repo</a>获取部署命令，启动 Kubenetes Proxy，通过它访问 Dashboard: <a href="http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/" target="_blank" rel="noopener">http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/</a> 。注意这里使用的是虚拟机的 localhost，所以我们更改 VirtualBox 的网络配置，添加一个端口映射到主节点的 8001 端口。(Kubernetes Proxy 就是一个反向代理，把外部请求通过主节点/集群，转发到工作节点/集群，避免直接暴露服务，降低安全风险)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml</span><br><span class="line">kubectl proxy --address 0.0.0.0 <span class="comment"># 允许虚拟机之外的流量</span></span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2018/11/23/5bf768a92f3f2.png" alt="Virtualbox | NAT port mapping"> <center><small>Virtualbox | NAT port mapping</small></center><br>但事与愿违，又出问题了，从宿主机用浏览器打开上述网址访问 Dashboard，返回如下 json。<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"kind"</span>: <span class="string">"Status"</span>,</span><br><span class="line">  <span class="attr">"apiVersion"</span>: <span class="string">"v1"</span>,</span><br><span class="line">  <span class="attr">"metadata"</span>: &#123;</span><br><span class="line">    </span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"status"</span>: <span class="string">"Failure"</span>,</span><br><span class="line">  <span class="attr">"message"</span>: <span class="string">"no endpoints available for service \"https:kubernetes-dashboard:\""</span>,</span><br><span class="line">  <span class="attr">"reason"</span>: <span class="string">"ServiceUnavailable"</span>,</span><br><span class="line">  <span class="attr">"code"</span>: <span class="number">503</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="Round-2-1-503"><a href="#Round-2-1-503" class="headerlink" title="Round 2.1 - 503"></a>Round 2.1 - 503</h3><p>执行命令<code>kubectl get pods -n kube-system</code>，发现 dashboard 跟之前 Weave Net 一样，无法正常创建 container，在工作节点执行<code>docker logs &lt;contianer_name|container_id&gt;</code>查看CNI插件的日志，发现它还是使用了 NAT 网卡的 ip 10.0.2.15，也就是虚拟机在自己的隔离网络的 ip，无法成功组网，在之前 “get nodes” “get pods” 显示一切正常，只是 <em>flannel</em> 跟 <em>Weave Net</em> 实现方式不一样而已。<br><img src="https://i.loli.net/2018/11/26/5bfba5999e281.png" alt="Node: worker | docker logs"><center><small>Node: worker | docker logs</small></center></p><p>大致原因清楚了，那怎么解决呢？”get nodes” 会不会有相关信息呢？接着，我找到了一个参数看到了各个节点的 ip，<code>kubectl get nodes -o wide</code>，可以看到所有的节点的 internal ip 都是 10.0.2.15。在刚开始，我不确定这个 “internal ip” 在 Kubernetes 里有什么含义，瞎找了一段时间，甚至修改 dashboard 的 yaml 文件，让它强制运行在主节点，但在后面部署其它 APP 的时候都出现了错误，无法被正常访问，只好继续寻找其它解决办法，最终让我在官方文档找到了更改它的方法。<br>这个 internal ip 定义在 kubelet 的启动参数，默认使用的是系统第一个网卡的 ip，在 kubelet 的启动参数里，它叫 “node-ip”。有两种方法，</p><ol><li>通过 kubeadm 控制 kubelet 启动参数</li><li>直接更改 kubelet 的启动参数</li></ol><p>首先尝试使用第一种方法，然后发现 kubeadm 不可以通过命令参数更改 kubelet 的启动参数，只能通过提供一个包含启动参数的配置文件给 kubeadm。关于这一部分的信息，在网上只有较少可以参考，通过搜索引擎找到了 GitHub 上有 issue 提到了通过创建一个配置文件达到我们的目的，而且我们可以把所有 kubeadm init, kubeadm join 的其它所有参数都定义在 kubeadm 的配置文件里，而 node ip 的更改也比较简单，只需要通过参数 “kubeletExtraArgs” 设置额外的参数个 kubelet 就可以了。</p><p>但有一部分参数，例如关于 “apiserver-advertise-address” 的设定始终不生效，最后凭借 GitHub 上的关键字在 kubeadm 的文档里找到了相关描述，原来它使用的配置文件的方法还是处于 alpha 阶段，而且 kubeadm join 需要用到的 token 是生成的，没办法写死在配置文件，再三考虑，还是放弃了这种办法，还是使用原来的办法，再配合一个脚本，更改 node ip，脚本内容如下，执行完后，重启 kubelet，docker ，使配置生效。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">InitConfiguration</span></span><br><span class="line"><span class="attr">apiEndpoint:</span></span><br><span class="line"><span class="attr">  advertiseAddress:</span> <span class="number">172.28</span><span class="number">.128</span><span class="number">.3</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line"><span class="attr">  kubeletExtraArgs:</span></span><br><span class="line"><span class="attr">    node-ip:</span> <span class="number">172.28</span><span class="number">.128</span><span class="number">.3</span></span><br><span class="line"><span class="attr">pod-network-cidr:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span><span class="string">/1</span></span><br></pre></td></tr></table></figure><center><small>YAML file for kubeadm init</small></center><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/bin/sh</span></span><br><span class="line"></span><br><span class="line">COND_NODE_IP=`sudo grep <span class="string">"node-ip"</span> /var/lib/kubelet/kubeadm-flags.env | wc -l`</span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$&#123;COND_NODE_IP&#125;</span> = 1 ]]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"--node-ip had been set, skipped"</span></span><br><span class="line">  <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">sudo sed -i <span class="string">'/^.*/ s/$/ --node-ip=172.28.128.3/'</span> /var/lib/kubelet/kubeadm-flags.env</span><br><span class="line">sudo systemctl restart kubelet</span><br></pre></td></tr></table></figure><center><small>Shell script for changing “node ip” on master</small></center><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/bin/sh</span></span><br><span class="line"></span><br><span class="line">COND_NODE_IP=`sudo grep <span class="string">"node-ip"</span> /var/lib/kubelet/kubeadm-flags.env | wc -l`</span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$&#123;COND_NODE_IP&#125;</span> = 1 ]]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"--node-ip had been set, skipped"</span></span><br><span class="line">  <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">sudo sed -i <span class="string">'/^.*/ s/$/ --node-ip=172.28.128.4/'</span> /var/lib/kubelet/kubeadm-flags.env</span><br><span class="line">sudo systemctl restart kubelet docker</span><br></pre></td></tr></table></figure><center><small>Shell script for changing “node ip” on worker</small></center><p><img src="https://i.loli.net/2018/11/26/5bfbbfd1a210f.png" alt="Node: master | get nodes"> <center><small>Node: master | get nodes</small></center></p><p>尝试部署 dashboard，还是不能访问，期间还尝试了好几种办法，包括：修改 <em>flannel</em> 的 YAML 文件；reset，重建虚拟机；切换其它的 CNI 插件；等等。无头绪之际，在 <em>flannel</em> 的 <a href="https://github.com/coreos/flannel/blob/master/Documentation/troubleshooting.md#vagrant" target="_blank" rel="noopener">Github Wik</a> 看到了一个很关键的信息：</p><blockquote><p>Vagrant typically assigns two interfaces to all VMs. The first, for which all hosts are assigned the IP address 10.0.2.15, is for external traffic that gets NATed.</p><p>This may lead to problems with flannel. By default, flannel selects the first interface on a host. This leads to all hosts thinking they have the same public IP address. To prevent this issue, pass the <code>--iface eth1</code> flag to flannel so that the second interface is chosen.</p></blockquote><p>默认使用网卡0？！ IP address 10.0.2.15 ？！这应该就是一直出问题的根源了！为了简单，我们还是切换回 <em>Weave Net</em>，<code>kubeadm reset</code>，把所有的东西重置，继续试验。</p><p>重置完成后，重新按照之前的流程，初始化，安装 CNI 插件（<em>Weave Net</em>）。<em>Weave Net</em> 还是在不断尝试连接 10.96.0.1。结合刚才看到的 <em>flannel</em> 的说明，跟踪路由看看请求去了哪里，在工作节点执行命令<code>traceroute 10.96.0.1</code>，可以在结果看到请求被路由到宿主机的网络了… 难怪一直无法连接，它在尝试连接到我们宿主机的内网 ip 为 10.96.0.1 的机器。</p><p>看下面👇截图里还有一个 ip，路由第一跳是 ip 10.0.2.2<br><img src="https://i.loli.net/2018/11/27/5bfd0ddf84222.png" alt="Node: worker | traceroute"><center><small>Node: worker | traceroute</small></center></p><p>灵光一动，想起来以前碰到过因为路由设置错误导致的网络问题，特意去复习了一下 Linux 路由知识。<br>在各个节点执行命令<code>ip route</code>查看路由表，可以看到虚拟机的路由表设置是让默认的请求全都通过 10.0.2.2 也就是宿主机的 NAT 网卡作出网络请求，</p><p>工作节点需要正常的连接到主节点，那么就必须让它的流量走 Host Only 网络，也就是网卡1，而不是通过网卡0上的 10.0.2.2 去尝试连接到宿主机的网络主机。</p><p>检查虚拟机 Host Only 的网卡的设置，在宿主机 Terminal 执行<code>ifconfig</code>查看对应的网卡的 ip 地址，这个 ip 就是我们用于让两台虚拟机正常通讯的路由 ip。<br><img src="https://i.loli.net/2018/11/28/5bfdfba3f3067.png" alt="Check the Host Only ip for route"> <center><small>Check the Host Only ip for route</small></center></p><p>使用 <code>kubeadm reset</code> 重设所有设定，别忘了执行之前写的更改 node-ip 的脚本，执行 ip route 相关的子命令更新路由表，让工作节点所有的流量通过网卡1，进而正确地让主节点、工作节点互相通讯。执行顺序如下。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在各个节点执行</span></span><br><span class="line">ip route <span class="comment">#查看路由表</span></span><br><span class="line">sudo kubeadm reset</span><br><span class="line"></span><br><span class="line"><span class="comment"># master节点</span></span><br><span class="line">sudo kubeadm init --apiserver-advertise-address=172.28.128.3</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">kubectl apply -f <span class="string">"https://cloud.weave.works/k8s/net?k8s-version=<span class="variable">$(kubectl version | base64 | tr -d '\n')</span>"</span></span><br><span class="line">bash change-kubelet-node-ip.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># node节点</span></span><br><span class="line">sudo kubeadm join 172.28.128.3:6443 --token &lt;token&gt; --discovery-token-ca-cert-hash &lt;token&gt; --apiserver-advertise-address=172.28.128.4</span><br><span class="line">bash change-kubelet-node-ip.sh</span><br><span class="line">sudo ip route del default via 10.0.2.2 &amp;&amp; sudo ip route add default via 172.28.128.1</span><br></pre></td></tr></table></figure><p>执行以下命令部署 Kubernetes Dashboard，在宿主机访问 <a href="http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/#!/login" target="_blank" rel="noopener">http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/#!/login</a> 验证部署结果。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml</span><br><span class="line">kubectl proxy --address 0.0.0.0</span><br></pre></td></tr></table></figure></p><h2 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h2><p>创建 NGINX 的yaml。<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    svc:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">9999</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  revisionHistoryLimit:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      svc:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        svc:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">          - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">            protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure></p><ul><li>执行命令<code>kubectl apply -f nginx-rs.yaml</code> 部署 nginx</li><li>启动 Kubernetes proxy <code>kubectl proxy --address 0.0.0.0</code></li><li>根据官方文档<a href="https://kubernetes.io/zh/docs/tasks/access-application-cluster/access-cluster/#%E6%89%8B%E5%8A%A8%E6%9E%84%E5%BB%BA-apiserver-%E4%BB%A3%E7%90%86-url" target="_blank" rel="noopener">相关描述</a>，在宿主机访问如下链接 <a href="http://localhost:8001/api/v1/namespaces/default/services/nginx/proxy/" target="_blank" rel="noopener">http://localhost:8001/api/v1/namespaces/default/services/nginx/proxy/</a></li><li>如果一切顺利，你将看到如下页面</li></ul><p><img src="https://i.loli.net/2019/03/01/5c78cf3876a85.png" alt="nginx via kube-proxy"><center><small>nginx via kube-proxy</small></center></p><h1 id="待续"><a href="#待续" class="headerlink" title="待续"></a>待续</h1><p>当初想写这篇文章是为了记录 Kubernetes 在本地虚拟环境下的集群部署流程的，没想到因为工作变动、踩坑、怠惰，使得这一篇文章拖了这么长的时间，因为对原理不熟，期间重复了很多次操作，以至于整个流程记录下来非常冗长，而且期间中断了好几次，所以语句可能会有不连贯的情况。接下来我将会重整整个流程写一篇姊妹篇 TL;DR 版，敬请期待。</p><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul><li><a href="https://github.com/kubernetes/dashboard/issues/916#issuecomment-307761029" target="_blank" rel="noopener">Dashboard running on master</a></li><li><a href="https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1alpha3#hdr-Kubeadm_init_configuration_types" target="_blank" rel="noopener">kubeadm with command - alpha - InitConfiguration</a></li><li><a href="https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1alpha3#hdr-Kubeadm_join_configuration_types" target="_blank" rel="noopener">kubeadm with command - alpha - JoinConfiguration</a></li><li><a href="https://github.com/kubernetes/kubernetes/issues/44702#issuecomment-304211078" target="_blank" rel="noopener">node-ip add to kubelet</a></li><li><a href="https://github.com/coreos/flannel/blob/master/Documentation/troubleshooting.md#vagrant" target="_blank" rel="noopener">troubleshooting - vagrant</a></li><li><a href="https://github.com/coreos/flannel/blob/master/Documentation/troubleshooting.md#vagrant" target="_blank" rel="noopener">vagrant network interface</a></li><li><a href="https://www.vagrantup.com/docs/networking/public_network.html" target="_blank" rel="noopener">vagrant network settings</a></li><li><a href="https://segmentfault.com/a/1190000000638244" target="_blank" rel="noopener">ip route usage - 1</a></li><li><a href="https://www.cnblogs.com/EasonJim/p/8424731.html" target="_blank" rel="noopener">ip route usage - 2</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;!-- toc --&gt;
&lt;!-- Description to show on index here  --&gt;
&lt;p&gt;在前一阵子参加了DevOps国际峰会(DevOps International Summit)，《DevOps Handbook》和《Beyond The Phoenix Project》的联合作者 John Willis 在他的分享中提出了“Kubernetes将成为未来的主流”，再加上我所在公司有大量的微服务架构项目使用到了Kubernetes，遂开始学习Kubernetes。&lt;br&gt;那要去学习它就必须得有可操作环境，在&lt;a href=&quot;https://kubernetes.io/docs/setup/pick-right-solution/#local-machine-solutions&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Kubernetes官网&lt;/a&gt;提供了好多个解决方案。&lt;/p&gt;
&lt;p&gt;我选择了难度稍高的 kubeadm 配合由 Vagrant 以及 Virtualbox 搭建的虚拟机创建 Kubernetes 的集群，通过使用 kubeadm 熟悉 Kubernetes 的部署流程以及它的原理。&lt;/p&gt;
&lt;h1 id=&quot;目标&quot;&gt;&lt;a href=&quot;#目标&quot; class=&quot;headerlink&quot; title=&quot;目标&quot;&gt;&lt;/a&gt;目标&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;启动两个虚拟机，一个作为主节点，一个作为工作节点&lt;/li&gt;
&lt;li&gt;熟悉 Kubeadm&lt;/li&gt;
&lt;li&gt;在集群上部署Kubernetes-dashboard、nginx
    
    </summary>
    
      <category term="Solutions" scheme="https://blog.stark-x.cn/categories/Solutions/"/>
    
    
      <category term="Ops" scheme="https://blog.stark-x.cn/tags/Ops/"/>
    
      <category term="Kubernetes" scheme="https://blog.stark-x.cn/tags/Kubernetes/"/>
    
      <category term="Vagrant" scheme="https://blog.stark-x.cn/tags/Vagrant/"/>
    
  </entry>
  
  <entry>
    <title>『上古神器』Vim</title>
    <link href="https://blog.stark-x.cn/2018/08/31/the-great-vim/"/>
    <id>https://blog.stark-x.cn/2018/08/31/the-great-vim/</id>
    <published>2018-08-31T12:00:00.000Z</published>
    <updated>2018-08-31T14:41:15.919Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><!-- Description to show on index here  --><blockquote><p><strong>Vim - the ubiquitous text editor</strong><br>Vim is a highly configurable text editor for efficiently creating and changing any kind of text. It is included as “vi” with most UNIX systems and with Apple OS X.<br>Vim 是一个可用于高效率创建或者编辑任意类型文本的高度定制化的文本编辑。它以”vi”命令存在于在大多数的UNIX 操作系统以及Apple OS X 中。</p><p align="right">— <a href="https://www.vim.org/" target="_blank" rel="noopener">https://www.vim.org/</a></p></blockquote><p>Vim 作为一个“上古”编辑器，它提供了很多很神奇高效的特性，以至于在现代编辑器/强大的IDE的选择之中有一席之地。<br>Vim有一个很合我心意的特性，在使用它的时候，完全不需要使用鼠标，眼睛看到哪就可以编辑哪，现在能支持Vim特性的地方我都安装上了对应的插件，例如Chrome的插件：Vimium, Idea的插件：Ideavim。<br><a id="more"></a></p><h2 id="入门教程"><a href="#入门教程" class="headerlink" title="入门教程"></a>入门教程</h2><p>网上有大量的入门教程，读者可以自行选择，在此推荐其中几个学习VIM的教程。</p><ul><li>Vim自带的互动教程，安装好Vim之后，在终端执行<code>vimtutor zh_CN</code>进入到互动教程中</li><li><a href="https://vim-adventures.com/" target="_blank" rel="noopener">vim-adverntures</a> 线上游戏的方式学习Vim</li><li><a href="https://www.openvim.com/tutorial.html" target="_blank" rel="noopener">openvim-tutorial</a> 网页互动教程</li></ul><p><small>* <em>Vim的学习曲线非常陡峭，在学习过程中可能会出现头晕、心悸、想砸键盘等情况。</em></small></p><h2 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h2><p>推荐阅读<a href="https://book.douban.com/subject/25869486/" target="_blank" rel="noopener">《Vim实用技巧》(Practical Vim)</a><br><img src="https://images-na.ssl-images-amazon.com/images/I/614qewK71jL.jpg" alt="Vim实用技巧" width="50%"></p><blockquote><p>I’ve been using Vim for server maintenance for more than fifteen years now, but I’ve only recently started using it for software development. I thought I knew Vim, but Practical Vim has massively improved my code-wrangling productivity.</p><p align="right">— Graeme Mathieson (Software Engineer, Rubaidh Ltd.)</p></blockquote><h2 id="As-IDE"><a href="#As-IDE" class="headerlink" title="As IDE"></a>As IDE</h2><p>在学习了以上的内容，相信读者已经可以使用Vim进行大部分的文本编辑工作了，但是把它作为写代码的工具，在没有经过任何配置的情况下，会让人觉得缺了点什么，没法作为主要编辑器，这个时候Vim的一大特性 — 插件，可以发挥它的作用了。配合适当的插件，Vim可以拥有文件树、自动补全等IDE提供的特性。<br>当然，在进行<strong>大项目</strong>的开发、重构的时候，我还是推荐使用IDE配合Vim插件。</p><h3 id="vimrc-位置"><a href="#vimrc-位置" class="headerlink" title="vimrc 位置"></a>vimrc 位置</h3><p>在Vim里执行<code>:help vimrc</code>，帮助文档里有列出vimrc的位置。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Places for your personal initializations:</span><br><span class="line">        Unix$HOME/.vimrc or $HOME/.vim/vimrc</span><br><span class="line">        OS/2$HOME/.vimrc, $HOME/vimfiles/vimrc</span><br><span class="line">                        or $VIM/.vimrc (or _vimrc)</span><br><span class="line">        MS-Windows$HOME/_vimrc, $HOME/vimfiles/vimrc</span><br><span class="line">                        or $VIM/_vimrc</span><br><span class="line">        Amigas:.vimrc, home:.vimrc, home:vimfiles:vimrc</span><br><span class="line">                        or $VIM/.vimrc</span><br></pre></td></tr></table></figure></p><h3 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h3><p>以下列表是我使用的插件，我使用了<a href="https://github.com/junegunn/vim-plug" target="_blank" rel="noopener"><code>Plug</code></a>管理这些插件，曾经我使用的是<a href="https://github.com/VundleVim/Vundle.vim" target="_blank" rel="noopener"><code>Vundle</code></a>，后来发现Plug有更强大的特性，就切换过去了。相对于<code>Vundle</code>，<code>Plug</code>还支持异步加载、异步更新、自定义触发安装函数等特性，大大增加了管理插件的效率、便捷性，最重要的是<code>Vundle</code>已经有差不多4年没有新的Release了。</p><ul><li><a href="https://github.com/tpope/vim-fugitive" target="_blank" rel="noopener">tpope/vim-fugitive</a>: Vim里使用Git</li><li><a href="https://github.com/Valloric/YouCompleteMe" target="_blank" rel="noopener"><strong>Valloric/YouCompleteMe</strong></a>: 必装，代码补全，代码提示</li><li><a href="https://github.com/Yggdroot/indentLine" target="_blank" rel="noopener">Yggdroot/indentLine</a>: 缩进参考线</li><li><a href="https://github.com/scrooloose/nerdtree" target="_blank" rel="noopener">scrooloose/nerdtree</a>: 文件目录树</li><li><a href="https://github.com/Xuyuanp/nerdtree-git-plugin" target="_blank" rel="noopener">Xuyuanp/nerdtree-git-plugin</a>: 在目录树中标识Git的仓库变更</li><li><a href="https://github.com/scrooloose/nerdcommenter" target="_blank" rel="noopener"><strong>scrooloose/nerdcommenter</strong></a>: 必装，快捷注释</li><li><a href="https://github.com/plasticboy/vim-markdown" target="_blank" rel="noopener">plasticboy/vim-markdown</a>: 支持Markdown语法高亮</li><li><a href="https://github.com/iamcco/markdown-preview.vim" target="_blank" rel="noopener">iamcco/markdown-preview.vim</a>: Markdown预览</li><li><a href="https://github.com/vim-airline/vim-airline" target="_blank" rel="noopener">vim-airline/vim-airline</a>: 优化的状态栏</li><li><a href="https://github.com/vim-airline/vim-airline-themes" target="_blank" rel="noopener">vim-airline/vim-airline-themes</a>: 状态栏主题</li><li><a href="https://github.com/SirVer/ultisnips" target="_blank" rel="noopener">SirVer/ultisnips</a>: 代码块支持，类似Idea系列的Live-Template</li><li><a href="https://github.com/honza/vim-snippets" target="_blank" rel="noopener">honza/vim-snippets</a>: 默认代码块，与”ultisnips”配合</li><li><a href="https://github.com/terryma/vim-multiple-cursors" target="_blank" rel="noopener">terryma/vim-multiple-cursors</a>: 支持多处同时修改</li><li><a href="https://github.com/altercation/vim-colors-solarized" target="_blank" rel="noopener">altercation/vim-colors-solarized</a>: solarized主题</li><li><a href="https://github.com/morhetz/gruvbox" target="_blank" rel="noopener">morhetz/gruvbox</a>: gruvbox主题</li><li><a href="https://github.com/mattn/emmet-vim" target="_blank" rel="noopener"><strong>mattn/emmet-vim</strong></a>: 前端程序员必装，快速编写标签</li><li><a href="https://github.com/tpope/vim-surround" target="_blank" rel="noopener">tpope/vim-surround</a>: 快速包括括号</li><li><a href="https://github.com/tpope/vim-repeat" target="_blank" rel="noopener">tpope/vim-repeat</a>: 让<code>.</code>正确重复部分插件的动作</li><li><a href="https://github.com/leafgarland/typescript-vim" target="_blank" rel="noopener">leafgarland/typescript-vim</a>: 支持Typescript</li><li><a href="https://github.com/w0rp/ale" target="_blank" rel="noopener">w0rp/ale</a>: 异步Lint引擎</li><li><a href="https://github.com/posva/vim-vue" target="_blank" rel="noopener">posva/vim-vue</a>: 支持Vue</li><li><a href="https://github.com/jiangmiao/auto-pairs" target="_blank" rel="noopener">jiangmiao/auto-pairs</a>: 自动补全括号，快速包括括号</li><li><a href="https://github.com/junegunn/vim-easy-align" target="_blank" rel="noopener">junegunn/vim-easy-align</a>: 快速对齐</li><li><a href="https://github.com/easymotion/vim-easymotion" target="_blank" rel="noopener">easymotion/vim-easymotion</a>: 快速移动当前光标</li><li><a href="https://github.com/python-mode/python-mode" target="_blank" rel="noopener">python-mode/python-mode</a>: 增强对Python的支持</li><li><a href="https://github.com/vim-scripts/groovyindent-unix" target="_blank" rel="noopener">vim-scripts/groovyindent-unix</a>: 正确的Groovy缩进</li><li><a href="https://github.com/Chiel92/vim-autoformat" target="_blank" rel="noopener">Chiel92/vim-autoformat</a>: 正确的格式化代码</li><li><a href="https://github.com/arecarn/vim-fold-cycle" target="_blank" rel="noopener">arecarn/vim-fold-cycle</a>: 快速展开关闭折叠</li><li><a href="https://github.com/pseewald/vim-anyfold" target="_blank" rel="noopener">pseewald/vim-anyfold</a>: 优化缩进</li><li><a href="https://github.com/xolox/vim-easytags" target="_blank" rel="noopener">xolox/vim-easytags</a>: 自动生成tag（用于列出函数/方法）</li><li><a href="https://github.com/vim-scripts/taglist.vim" target="_blank" rel="noopener">vim-scripts/taglist.vim</a>: 官方tag支持</li><li><a href="https://github.com/xolox/vim-misc" target="_blank" rel="noopener">xolox/vim-misc</a>: xolox的插件的支持</li><li><a href="https://github.com/chemzqm/wxapp.vim" target="_blank" rel="noopener">chemzqm/wxapp.vim</a>: 支持微信小程序开发</li><li><a href="https://github.com/sheerun/vim-polyglot" target="_blank" rel="noopener">sheerun/vim-polyglot</a>: 语法支持增强</li><li><a href="https://github.com/mileszs/ack.vim" target="_blank" rel="noopener">mileszs/ack.vim</a>: 文件内容快速搜索（当前工作目录下的所有文件）</li><li><a href="https://github.com/junegunn/fzf" target="_blank" rel="noopener">junegunn/fzf</a>: 模糊搜索的依赖</li><li><a href="https://github.com/junegunn/fzf.vim" target="_blank" rel="noopener">junegunn/fzf.vim</a>: 文件名、目录模糊搜索（当前工作目录下的所有文件）</li></ul><h2 id="参考配置"><a href="#参考配置" class="headerlink" title="参考配置"></a>参考配置</h2><p>Github: <a href="https://github.com/Stark-X/dotfiles/blob/master/vim/.vimrc" target="_blank" rel="noopener">https://github.com/Stark-X/dotfiles/blob/master/vim/.vimrc</a><br>这是我的vimrc，读者可以根据自己的习惯作出相应调整，欢迎大家在评论区提出建议、疑问。</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">" Remove python3(3.7) importlib deprecated warning</span></span><br><span class="line"><span class="string">" It had been fixed from "</span>patch-<span class="number">8.1</span>.<span class="number">201</span><span class="comment">"</span></span><br><span class="line"><span class="comment">" https://github.com/vim/vim/issues/3117</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">has</span>(<span class="string">'python3'</span>) &amp;&amp; !has(<span class="string">'patch-8.1.201'</span>)</span><br><span class="line">  silent! <span class="keyword">python3</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="string">"set nocompatible              "</span> <span class="keyword">be</span> iMproved, required</span><br><span class="line"><span class="keyword">filetype</span> off                  <span class="comment">" required</span></span><br><span class="line"></span><br><span class="line"><span class="comment">" Initialize for the vim-plug</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">has</span>(<span class="string">'win32'</span>)</span><br><span class="line">    <span class="comment">" set rtp+=$USERPROFILE/vimfiles/bundle/Vundle.vim/</span></span><br><span class="line">    <span class="keyword">call</span> plug#begin(<span class="string">'$USERPROFILE/vimfiles/bundle/'</span>)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment">" set rtp+=~/.vim/bundle/Vundle.vim/</span></span><br><span class="line">    <span class="keyword">call</span> plug#begin(<span class="string">'~/.vim/bundle/'</span>)</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line">Plug <span class="string">'tpope/vim-fugitive'</span></span><br><span class="line">Plug <span class="string">'vim-scripts/L9'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">" Post-update hooks to compile the YCM</span></span><br><span class="line"><span class="comment">" ==================== YouCompleteMe ====================</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>! <span class="title">BuildYCM</span><span class="params">(info)</span></span></span><br><span class="line">  <span class="comment">" info is a dictionary with 3 fields</span></span><br><span class="line">  <span class="comment">" - name:   name of the plugin</span></span><br><span class="line">  <span class="comment">" - status: 'installed', 'updated', or 'unchanged'</span></span><br><span class="line">  <span class="comment">" - force:  set on PlugInstall! or PlugUpdate!</span></span><br><span class="line">  <span class="keyword">if</span> <span class="variable">a:info</span>.status == <span class="string">'installed'</span> || <span class="variable">a:info</span>.force</span><br><span class="line">    !./install.<span class="keyword">py</span> --<span class="keyword">go</span>-completer --js-completer --java-completer --clang-completer</span><br><span class="line">  <span class="keyword">endif</span></span><br><span class="line"><span class="keyword">endfunction</span></span><br><span class="line">Plug <span class="string">'Valloric/YouCompleteMe'</span>, &#123; <span class="string">'do'</span>: <span class="function"><span class="keyword">function</span><span class="params">('BuildYCM')</span> &#125;</span></span><br><span class="line"><span class="comment">" ==================== YouCompleteMe ====================</span></span><br><span class="line"></span><br><span class="line">Plug <span class="string">'Yggdroot/indentLine'</span></span><br><span class="line">Plug <span class="string">'scrooloose/nerdtree'</span>, &#123; <span class="string">'on'</span>: <span class="string">'NERDTreeToggle'</span> &#125;</span><br><span class="line">Plug <span class="string">'Xuyuanp/nerdtree-git-plugin'</span></span><br><span class="line"><span class="keyword">map</span> <span class="symbol">&lt;f3&gt;</span> :NERDTreeToggle<span class="symbol">&lt;CR&gt;</span></span><br><span class="line"><span class="comment">" Ignore *.pyc</span></span><br><span class="line"><span class="keyword">let</span> NERDTreeIgnore = [<span class="string">'\.pyc$'</span>]</span><br><span class="line">autocmd! User nerdtree <span class="keyword">echom</span> <span class="string">'NERDTree is now loaded.'</span></span><br><span class="line"></span><br><span class="line">Plug <span class="string">'scrooloose/nerdcommenter'</span></span><br><span class="line"><span class="comment">" markdown syntax highlight</span></span><br><span class="line">Plug <span class="string">'plasticboy/vim-markdown'</span></span><br><span class="line">Plug <span class="string">'iamcco/markdown-preview.vim'</span>, &#123; <span class="string">'for'</span>: <span class="string">'markdown'</span> &#125;</span><br><span class="line">autocmd! User markdown-preview.<span class="keyword">vim</span> <span class="keyword">echom</span> <span class="string">'MarkdownPreview is now loaded.'</span></span><br><span class="line"></span><br><span class="line">Plug <span class="string">'vim-airline/vim-airline'</span></span><br><span class="line">Plug <span class="string">'vim-airline/vim-airline-themes'</span></span><br><span class="line"><span class="comment">" ==================== Snippets ====================</span></span><br><span class="line">Plug <span class="string">'SirVer/ultisnips'</span></span><br><span class="line">Plug <span class="string">'honza/vim-snippets'</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:UltiSnipsExpandTrigger</span>=<span class="string">"&lt;tab&gt;&lt;tab&gt;"</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:UltiSnipsJumpForwardTrigger</span>=<span class="string">"&lt;c-b&gt;"</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:UltiSnipsJumpBackwardTrigger</span>=<span class="string">"&lt;c-z&gt;"</span></span><br><span class="line"><span class="comment">" ==================== Snippets ====================</span></span><br><span class="line"></span><br><span class="line">Plug <span class="string">'terryma/vim-multiple-cursors'</span></span><br><span class="line">Plug <span class="string">'altercation/vim-colors-solarized'</span></span><br><span class="line">Plug <span class="string">'morhetz/gruvbox'</span></span><br><span class="line">Plug <span class="string">'mattn/emmet-vim'</span></span><br><span class="line">Plug <span class="string">'tpope/vim-surround'</span></span><br><span class="line">Plug <span class="string">'tpope/vim-repeat'</span></span><br><span class="line">Plug <span class="string">'leafgarland/typescript-vim'</span></span><br><span class="line"><span class="comment">" Plug 'ctrlpvim/ctrlp.vim'</span></span><br><span class="line"><span class="comment">" Asynchronous Lint Engine</span></span><br><span class="line">Plug <span class="string">'w0rp/ale'</span></span><br><span class="line">Plug <span class="string">'posva/vim-vue'</span></span><br><span class="line">Plug <span class="string">'jiangmiao/auto-pairs'</span></span><br><span class="line">Plug <span class="string">'junegunn/vim-easy-align'</span></span><br><span class="line">Plug <span class="string">'easymotion/vim-easymotion'</span></span><br><span class="line"><span class="comment">" Themes</span></span><br><span class="line">Plug <span class="string">'sjl/badwolf'</span></span><br><span class="line"><span class="comment">" Optimization for Python</span></span><br><span class="line">Plug <span class="string">'python-mode/python-mode'</span>, &#123; <span class="string">'for'</span>: <span class="string">'python'</span> &#125;</span><br><span class="line">autocmd! User <span class="keyword">python</span>-<span class="keyword">mode</span> <span class="keyword">echom</span> <span class="string">'Python-Mode is now loaded.'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">" ==================== Auto Format ====================</span></span><br><span class="line">Plug <span class="string">'vim-scripts/groovyindent-unix'</span></span><br><span class="line">Plug <span class="string">'Chiel92/vim-autoformat'</span></span><br><span class="line"><span class="keyword">noremap</span> <span class="symbol">&lt;F4&gt;</span> :Autoformat<span class="symbol">&lt;CR&gt;</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:formatter_yapf_style</span> = <span class="string">'pep8'</span></span><br><span class="line"><span class="comment">" ==================== Auto Format ====================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">" ==================== Code Folding ====================</span></span><br><span class="line">Plug <span class="string">'arecarn/vim-fold-cycle'</span></span><br><span class="line">Plug <span class="string">'pseewald/vim-anyfold'</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:fold_cycle_default_mapping</span> = <span class="number">0</span> <span class="comment">"disable default mappings</span></span><br><span class="line"><span class="keyword">nmap</span> &lt;+&gt; <span class="symbol">&lt;Plug&gt;</span>(<span class="keyword">fold</span>-cycle-<span class="keyword">open</span>)</span><br><span class="line"><span class="keyword">nmap</span> <span class="symbol">&lt;-&gt;</span> <span class="symbol">&lt;Plug&gt;</span>(<span class="keyword">fold</span>-cycle-<span class="keyword">close</span>)</span><br><span class="line"><span class="keyword">autocmd</span> Filetype <span class="keyword">python</span> <span class="keyword">let</span> <span class="variable">b:anyfold_activate</span>=<span class="number">1</span></span><br><span class="line"><span class="keyword">set</span> <span class="built_in">foldlevel</span>=<span class="number">0</span></span><br><span class="line"><span class="comment">" ==================== Code Folding ====================</span></span><br><span class="line"><span class="comment">" ==================== Tags Generator ====================</span></span><br><span class="line"><span class="comment">" Use ^] to jump to definiation</span></span><br><span class="line">Plug <span class="string">'xolox/vim-easytags'</span></span><br><span class="line">Plug <span class="string">'xolox/vim-misc'</span></span><br><span class="line"><span class="comment">" ==================== Tags Generator ====================</span></span><br><span class="line"><span class="comment">" ==================== Tag List ====================</span></span><br><span class="line">Plug <span class="string">'vim-scripts/taglist.vim'</span>, &#123; <span class="string">'on'</span>: <span class="string">'TlistToggle'</span> &#125;</span><br><span class="line"><span class="keyword">noremap</span> <span class="symbol">&lt;F2&gt;</span> :TlistToggle<span class="symbol">&lt;CR&gt;</span></span><br><span class="line"><span class="comment">" ==================== Tag List ====================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">" ==================== WeChat App ====================</span></span><br><span class="line">Plug <span class="string">'chemzqm/wxapp.vim'</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:neomake_wxml_enabled_makers</span> = [<span class="string">'tidy'</span>, <span class="string">'stylelint'</span>]</span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:user_emmet_settings</span> = &#123;</span><br><span class="line">  \ <span class="string">'wxss'</span>: &#123;</span><br><span class="line">  \   <span class="string">'extends'</span>: <span class="string">'css'</span>,</span><br><span class="line">  \ &#125;,</span><br><span class="line">  \ <span class="string">'wxml'</span>: &#123;</span><br><span class="line">  \   <span class="string">'extends'</span>: <span class="string">'html'</span>,</span><br><span class="line">  \   <span class="string">'aliases'</span>: &#123;</span><br><span class="line">  \     <span class="string">'div'</span>: <span class="string">'view'</span>,</span><br><span class="line">  \     <span class="string">'span'</span>: <span class="string">'text'</span>,</span><br><span class="line">  \   &#125;,</span><br><span class="line">  \  <span class="string">'default_attributes'</span>: &#123;</span><br><span class="line">  \     <span class="string">'block'</span>: [&#123;<span class="string">'wx:for-items'</span>: <span class="string">'&#123;&#123;list&#125;&#125;'</span>,<span class="string">'wx:for-item'</span>: <span class="string">'&#123;&#123;item&#125;&#125;'</span>&#125;],</span><br><span class="line">  \     <span class="string">'navigator'</span>: [&#123;<span class="string">'url'</span>: <span class="string">''</span>, <span class="string">'redirect'</span>: <span class="string">'false'</span>&#125;],</span><br><span class="line">  \     <span class="string">'scroll-view'</span>: [&#123;<span class="string">'bindscroll'</span>: <span class="string">''</span>&#125;],</span><br><span class="line">  \     <span class="string">'swiper'</span>: [&#123;<span class="string">'autoplay'</span>: <span class="string">'false'</span>, <span class="string">'current'</span>: <span class="string">'0'</span>&#125;],</span><br><span class="line">  \     <span class="string">'icon'</span>: [&#123;<span class="string">'type'</span>: <span class="string">'success'</span>, <span class="string">'size'</span>: <span class="string">'23'</span>&#125;],</span><br><span class="line">  \     <span class="string">'progress'</span>: [&#123;<span class="string">'precent'</span>: <span class="string">'0'</span>&#125;],</span><br><span class="line">  \     <span class="string">'button'</span>: [&#123;<span class="string">'size'</span>: <span class="string">'default'</span>&#125;],</span><br><span class="line">  \     <span class="string">'checkbox-group'</span>: [&#123;<span class="string">'bindchange'</span>: <span class="string">''</span>&#125;],</span><br><span class="line">  \     <span class="string">'checkbox'</span>: [&#123;<span class="string">'value'</span>: <span class="string">''</span>, <span class="string">'checked'</span>: <span class="string">''</span>&#125;],</span><br><span class="line">  \     <span class="string">'form'</span>: [&#123;<span class="string">'bindsubmit'</span>: <span class="string">''</span>&#125;],</span><br><span class="line">  \     <span class="string">'input'</span>: [&#123;<span class="string">'type'</span>: <span class="string">'text'</span>&#125;],</span><br><span class="line">  \     <span class="string">'label'</span>: [&#123;<span class="string">'for'</span>: <span class="string">''</span>&#125;],</span><br><span class="line">  \     <span class="string">'picker'</span>: [&#123;<span class="string">'bindchange'</span>: <span class="string">''</span>&#125;],</span><br><span class="line">  \     <span class="string">'radio-group'</span>: [&#123;<span class="string">'bindchange'</span>: <span class="string">''</span>&#125;],</span><br><span class="line">  \     <span class="string">'radio'</span>: [&#123;<span class="string">'checked'</span>: <span class="string">''</span>&#125;],</span><br><span class="line">  \     <span class="string">'switch'</span>: [&#123;<span class="string">'checked'</span>: <span class="string">''</span>&#125;],</span><br><span class="line">  \     <span class="string">'slider'</span>: [&#123;<span class="string">'value'</span>: <span class="string">''</span>&#125;],</span><br><span class="line">  \     <span class="string">'action-sheet'</span>: [&#123;<span class="string">'bindchange'</span>: <span class="string">''</span>&#125;],</span><br><span class="line">  \     <span class="string">'modal'</span>: [&#123;<span class="string">'title'</span>: <span class="string">''</span>&#125;],</span><br><span class="line">  \     <span class="string">'loading'</span>: [&#123;<span class="string">'bindchange'</span>: <span class="string">''</span>&#125;],</span><br><span class="line">  \     <span class="string">'toast'</span>: [&#123;<span class="string">'duration'</span>: <span class="string">'1500'</span>&#125;],</span><br><span class="line">  \     <span class="string">'audio'</span>: [&#123;<span class="string">'src'</span>: <span class="string">''</span>&#125;],</span><br><span class="line">  \     <span class="string">'video'</span>: [&#123;<span class="string">'src'</span>: <span class="string">''</span>&#125;],</span><br><span class="line">  \     <span class="string">'image'</span>: [&#123;<span class="string">'src'</span>: <span class="string">''</span>, <span class="string">'mode'</span>: <span class="string">'scaleToFill'</span>&#125;],</span><br><span class="line">  \   &#125;</span><br><span class="line">  \ &#125;,</span><br><span class="line">  \&#125;</span><br><span class="line"><span class="comment">" ==================== WeChat App ====================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">" ==================== Syntax Support  ====================</span></span><br><span class="line"><span class="comment">" Plug 'martinda/Jenkinsfile-vim-syntax'</span></span><br><span class="line">Plug <span class="string">'sheerun/vim-polyglot'</span></span><br><span class="line"><span class="comment">" ==================== Syntax Support  ====================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">" ==================== ACK ====================</span></span><br><span class="line"><span class="comment">" Take place the vimgrep</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>! <span class="title">Install_ag</span><span class="params">(info)</span></span></span><br><span class="line">    <span class="comment">" info is a dictionary with 3 fields</span></span><br><span class="line">    <span class="comment">" - name:   name of the plugin</span></span><br><span class="line">    <span class="comment">" - status: 'installed', 'updated', or 'unchanged'</span></span><br><span class="line">    <span class="comment">" - force:  set on PlugInstall! or PlugUpdate!</span></span><br><span class="line">    <span class="keyword">if</span> <span class="variable">a:info</span>.status == <span class="string">'installed'</span> || <span class="variable">a:info</span>.force</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">has</span>(<span class="string">'macunix'</span>)</span><br><span class="line">            !brew install the_silver_searcher </span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'Please access https://github.com/ggreer/the_silver_searcher for the installation'</span></span><br><span class="line">        <span class="keyword">endif</span></span><br><span class="line">    <span class="keyword">endif</span></span><br><span class="line"><span class="keyword">endfunction</span></span><br><span class="line"><span class="comment">" Use ag(the_silver_searcher) as the search engine</span></span><br><span class="line">Plug <span class="string">'mileszs/ack.vim'</span>, &#123; <span class="string">'do'</span>: <span class="function"><span class="keyword">function</span><span class="params">('Install_ag')</span> &#125;</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:ackprg</span> = <span class="string">'ag --vimgrep --hidden'</span></span><br><span class="line"><span class="comment">" ==================== ACK ====================</span></span><br><span class="line"></span><br><span class="line">Plug <span class="string">'junegunn/fzf'</span>, &#123; <span class="string">'dir'</span>: <span class="string">'~/.fzf'</span>, <span class="string">'do'</span>: <span class="string">'./install --all'</span> &#125;</span><br><span class="line">Plug <span class="string">'junegunn/fzf.vim'</span></span><br><span class="line"><span class="keyword">nmap</span> <span class="symbol">&lt;leader&gt;</span><span class="symbol">&lt;tab&gt;</span> <span class="symbol">&lt;plug&gt;</span>(fzf-maps-n)</span><br><span class="line"><span class="keyword">xmap</span> <span class="symbol">&lt;leader&gt;</span><span class="symbol">&lt;tab&gt;</span> <span class="symbol">&lt;plug&gt;</span>(fzf-maps-<span class="keyword">x</span>)</span><br><span class="line"><span class="keyword">omap</span> <span class="symbol">&lt;leader&gt;</span><span class="symbol">&lt;tab&gt;</span> <span class="symbol">&lt;plug&gt;</span>(fzf-maps-<span class="keyword">o</span>)</span><br><span class="line"><span class="keyword">nmap</span> <span class="symbol">&lt;C-P&gt;</span> :Files<span class="symbol">&lt;CR&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">" All of your Plugs must be added before the following line</span></span><br><span class="line"><span class="keyword">call</span> plug#end()            <span class="comment">" required</span></span><br><span class="line"></span><br><span class="line"><span class="comment">" To ignore plugin indent changes, instead use:</span></span><br><span class="line"><span class="comment">"filetype plugin on</span></span><br><span class="line"><span class="comment">"</span></span><br><span class="line"><span class="comment">"-----------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">" Configuration file for vim</span></span><br><span class="line"><span class="keyword">set</span> modelines=<span class="number">0</span><span class="comment">" CVE-2007-2438</span></span><br><span class="line"></span><br><span class="line"><span class="comment">" Normally we use vim-extensions. If you want true vi-compatibility</span></span><br><span class="line"><span class="comment">" remove change the following statements</span></span><br><span class="line"><span class="keyword">set</span> nocompatible<span class="comment">" Use Vim defaults instead of 100% vi compatibility</span></span><br><span class="line"><span class="keyword">set</span> backspace=<span class="number">2</span><span class="comment">" more powerful backspacing</span></span><br><span class="line"></span><br><span class="line"><span class="string">" Don't write backup file if vim is being called by "</span>crontab -<span class="keyword">e</span><span class="comment">"</span></span><br><span class="line"><span class="keyword">au</span> BufWrite /private/tmp/crontab.* <span class="keyword">set</span> nowritebackup</span><br><span class="line"><span class="string">" Don't write backup file if vim is being called by "</span>chpass<span class="comment">"</span></span><br><span class="line"><span class="keyword">au</span> BufWrite /private/etc/<span class="keyword">pw</span>.* <span class="keyword">set</span> nowritebackup</span><br><span class="line"></span><br><span class="line"><span class="comment">" theme</span></span><br><span class="line"><span class="keyword">set</span> background=dark</span><br><span class="line"><span class="comment">" let g:solarized_termcolors=256</span></span><br><span class="line"><span class="comment">" colorscheme solarized</span></span><br><span class="line"><span class="comment">"colorscheme desert</span></span><br><span class="line"><span class="comment">" colorscheme gruvbox </span></span><br><span class="line"><span class="string">" let g:gruvbox_contrast_dark="</span>hard<span class="comment">"</span></span><br><span class="line"><span class="keyword">colorscheme</span> badwolf</span><br><span class="line"><span class="keyword">set</span> guifont=Source_Code_Pro:h13</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> hls</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">nu</span></span><br><span class="line"><span class="keyword">set</span> tabstop=<span class="number">8</span></span><br><span class="line"><span class="keyword">set</span> <span class="built_in">shiftwidth</span>=<span class="number">4</span></span><br><span class="line"><span class="keyword">set</span> softtabstop=<span class="number">8</span></span><br><span class="line"><span class="keyword">set</span> smarttab</span><br><span class="line"><span class="keyword">set</span> smartindent</span><br><span class="line"><span class="keyword">set</span> expandtab</span><br><span class="line"><span class="comment">"突出显示当前行</span></span><br><span class="line"><span class="keyword">set</span> cursorline</span><br><span class="line"><span class="comment">"开启状态栏</span></span><br><span class="line"><span class="keyword">set</span> laststatus=<span class="number">2</span></span><br><span class="line"><span class="comment">"显示输入的命令</span></span><br><span class="line"><span class="keyword">set</span> showcmd</span><br><span class="line"><span class="comment">"在状态栏显示当前光标位置</span></span><br><span class="line"><span class="keyword">set</span> ruler</span><br><span class="line"><span class="comment">"命令模式下按tab列出补全的命令</span></span><br><span class="line"><span class="keyword">set</span> wildmenu</span><br><span class="line"></span><br><span class="line"><span class="keyword">vmap</span> <span class="symbol">&lt;C-c&gt;</span> <span class="comment">"+y</span></span><br><span class="line"><span class="keyword">imap</span> jk <span class="symbol">&lt;Esc&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">autocmd</span> FileType <span class="keyword">c</span>,cpp <span class="keyword">setlocal</span> <span class="built_in">cindent</span></span><br><span class="line"><span class="keyword">autocmd</span> FileType feature <span class="keyword">setlocal</span> <span class="built_in">shiftwidth</span>=<span class="number">2</span></span><br><span class="line"><span class="keyword">autocmd</span> FileType <span class="keyword">make</span> <span class="keyword">setlocal</span> noet</span><br><span class="line"><span class="keyword">autocmd</span> FileType groovy <span class="keyword">setlocal</span> <span class="built_in">cindent</span></span><br><span class="line"><span class="keyword">autocmd</span> FileType yaml,<span class="keyword">conf</span>,json,javascript,vue,markdown <span class="keyword">setlocal</span> <span class="built_in">cindent</span> <span class="keyword">sw</span>=<span class="number">2</span></span><br><span class="line"><span class="keyword">autocmd</span> Filetype markdown <span class="keyword">setlocal</span> spell</span><br><span class="line"></span><br><span class="line"><span class="comment">" for typescript-vim</span></span><br><span class="line"><span class="keyword">autocmd</span> QuickFixCmdPost [^<span class="keyword">l</span>]* nested <span class="keyword">cwindow</span></span><br><span class="line"><span class="keyword">autocmd</span> QuickFixCmdPost    <span class="keyword">l</span>* nested <span class="keyword">lwindow</span></span><br><span class="line"><span class="keyword">autocmd</span> FileType typescript :<span class="keyword">setlocal</span> makeprg=tsc <span class="comment">" find the tsconfig.json to compile</span></span><br><span class="line"></span><br><span class="line"><span class="comment">"markdown-setting: YAML</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:vim_markdown_frontmatter</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">"YCM_Settings</span></span><br><span class="line"><span class="keyword">nnoremap</span> <span class="symbol">&lt;leader&gt;</span>jd :YcmCompleter GoToDefinitionElseDeclaration<span class="symbol">&lt;CR&gt;</span></span><br><span class="line"><span class="comment">" nnoremap &lt;F5&gt; :YcmForceCompileAndDiagnostics&lt;CR&gt;</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:syntastic_cpp_compiler</span>=<span class="string">'g++'</span> <span class="comment">"change the compiler to 'g++' to support c++11</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:syntastic_cpp_compiler_options</span>=<span class="string">'-std=c++11 -stdlib=libc++'</span>  <span class="comment">"set the options of g++ to support c++11</span></span><br><span class="line"><span class="comment">" YCM with TypeScript</span></span><br><span class="line"><span class="keyword">if</span> !exists(<span class="string">"g:ycm_semantic_triggers"</span>)</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">g:ycm_semantic_triggers</span> = &#123;&#125;</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:ycm_semantic_triggers</span>[<span class="string">'typescript'</span>] = [<span class="string">'.'</span>]</span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:ycm_autoclose_preview_window_after_completion</span> = <span class="number">1</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:ycm_server_python_interpreter</span> = <span class="string">'python3'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">"MarkdownPreview-KeyMapping</span></span><br><span class="line"><span class="keyword">nmap</span> <span class="symbol">&lt;silent&gt;</span> <span class="symbol">&lt;F8&gt;</span> <span class="symbol">&lt;Plug&gt;</span>MarkdownPreview        <span class="comment">" for normal mode</span></span><br><span class="line"><span class="keyword">imap</span> <span class="symbol">&lt;silent&gt;</span> <span class="symbol">&lt;F8&gt;</span> <span class="symbol">&lt;Plug&gt;</span>MarkdownPreview        <span class="comment">" for insert mode</span></span><br><span class="line"><span class="keyword">nmap</span> <span class="symbol">&lt;silent&gt;</span> <span class="symbol">&lt;F9&gt;</span> <span class="symbol">&lt;Plug&gt;</span>StopMarkdownPreview    <span class="comment">" for normal mode</span></span><br><span class="line"><span class="keyword">imap</span> <span class="symbol">&lt;silent&gt;</span> <span class="symbol">&lt;F9&gt;</span> <span class="symbol">&lt;Plug&gt;</span>StopMarkdownPreview    <span class="comment">" for insert mode</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">has</span>(<span class="string">'win32'</span>)</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">g:mkdp_path_to_chrome</span> = <span class="string">'C:\Program Files (x86)\Google\Chrome\Application\chrome.exe'</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">has</span>(<span class="string">'macunix'</span>)</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">g:mkdp_path_to_chrome</span> = <span class="string">"open -a Google\\ Chrome"</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">has</span>(<span class="string">"gui_macvim"</span>)</span><br><span class="line">    <span class="comment">" Only work on MacVim, the iTerm2 will use ^[</span></span><br><span class="line">    <span class="keyword">set</span> macmeta</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:mkdp_auto_close</span> = <span class="number">1</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:mkdp_auto_open</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">"copy and paste</span></span><br><span class="line"><span class="keyword">vmap</span> <span class="symbol">&lt;Leader&gt;</span><span class="keyword">y</span> <span class="comment">"+y</span></span><br><span class="line"><span class="keyword">vmap</span> <span class="symbol">&lt;Leader&gt;</span><span class="keyword">p</span> <span class="comment">"+p</span></span><br><span class="line"><span class="keyword">nmap</span> <span class="symbol">&lt;Leader&gt;</span><span class="keyword">p</span> <span class="comment">"+p</span></span><br><span class="line"><span class="keyword">vmap</span> <span class="symbol">&lt;Leader&gt;</span><span class="keyword">P</span> <span class="comment">"+P</span></span><br><span class="line"><span class="keyword">nmap</span> <span class="symbol">&lt;Leader&gt;</span><span class="keyword">P</span> <span class="comment">"+P</span></span><br><span class="line"></span><br><span class="line"><span class="comment">" default width and height</span></span><br><span class="line"><span class="comment">" set lines=27 columns=100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">" Emmet (C-y ,)</span></span><br><span class="line"><span class="keyword">autocmd</span> FileType html,css,vue EmmetInstall</span><br><span class="line"></span><br><span class="line"><span class="comment">" let the markdown files link normal</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:vim_markdown_conceal</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">" vertical split resize</span></span><br><span class="line"><span class="keyword">nmap</span> <span class="symbol">&lt;c-w&gt;</span>[ :<span class="keyword">vertical</span> <span class="keyword">resize</span> -<span class="number">5</span><span class="symbol">&lt;CR&gt;</span></span><br><span class="line"><span class="keyword">nmap</span> <span class="symbol">&lt;c-w&gt;</span>] :<span class="keyword">vertical</span> <span class="keyword">resize</span> +<span class="number">5</span><span class="symbol">&lt;CR&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">" improve performance</span></span><br><span class="line"><span class="keyword">set</span> lazyredraw</span><br><span class="line"></span><br><span class="line"><span class="comment">" airline realted</span></span><br><span class="line"><span class="string">" let g:airline_theme="</span>wombat<span class="comment">"</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:airline_theme</span>=<span class="string">'badwolf'</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:airline_powerline_fonts</span> = <span class="number">1</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:airline</span>#extensions#tabline#enabled = <span class="number">1</span></span><br><span class="line"><span class="keyword">set</span> encoding=utf-<span class="number">8</span></span><br><span class="line"><span class="keyword">set</span> rop=<span class="built_in">type</span>:directx,gamm<span class="variable">a:1</span>.<span class="number">0</span>,contras<span class="variable">t:0</span>.<span class="number">5</span>,leve<span class="variable">l:1</span>,geom:<span class="number">1</span>,renmode:<span class="number">4</span>,taamode:<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">" makes the % command work better</span></span><br><span class="line">packadd matchit</span><br><span class="line"></span><br><span class="line"><span class="comment">" ALE setting</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:ale_echo_msg_format</span> = <span class="string">'[%linter%] %s [%severity%]'</span></span><br><span class="line"><span class="keyword">nmap</span> <span class="symbol">&lt;silent&gt;</span> <span class="symbol">&lt;C-k&gt;</span> <span class="symbol">&lt;Plug&gt;</span>(ale_previous_wrap)</span><br><span class="line"><span class="keyword">nmap</span> <span class="symbol">&lt;silent&gt;</span> <span class="symbol">&lt;C-j&gt;</span> <span class="symbol">&lt;Plug&gt;</span>(ale_next_wrap)</span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:ale_linters</span> = &#123;</span><br><span class="line">\   <span class="string">'javascript'</span>: [<span class="string">'standard'</span>],</span><br><span class="line">\   <span class="string">'typescript'</span>: [<span class="string">'tslint'</span>],</span><br><span class="line">\   <span class="string">'python'</span>: [<span class="string">'autopep8'</span>]</span><br><span class="line">\&#125;</span><br><span class="line"><span class="comment">" Fix files when they are saved.</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:ale_fix_on_save</span> = <span class="number">1</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">b:ale_fixers</span> = [<span class="string">'prettier'</span>, <span class="string">'eslint'</span>, <span class="string">'autopep8'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">has</span>(<span class="string">'win32'</span>)</span><br><span class="line">    <span class="keyword">source</span> $VIMRUNTIME/mswin.<span class="keyword">vim</span></span><br><span class="line">    <span class="keyword">behave</span> mswin</span><br><span class="line">    <span class="keyword">set</span> encoding=utf-<span class="number">8</span></span><br><span class="line">    <span class="keyword">set</span> fileencodings=ucs-bom,utf-<span class="number">8</span>,cp936,gb18030,big5,euc-jp,euc-kr,latin1</span><br><span class="line">    <span class="keyword">set</span> fileencoding=utf-<span class="number">8</span> <span class="comment">" 新建文件使用的编码</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">" 解决菜单乱码</span></span><br><span class="line">    <span class="keyword">set</span> langmenu=zh_CN</span><br><span class="line">    <span class="keyword">let</span> $LANG = <span class="string">'zh_CN.UTF-8'</span></span><br><span class="line">    <span class="keyword">source</span> $VIMRUNTIME/delmenu.<span class="keyword">vim</span></span><br><span class="line">    <span class="keyword">source</span> $VIMRUNTIME/<span class="keyword">menu</span>.<span class="keyword">vim</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">" Disable the alt/meta (&lt;M-*&gt;) mapping on the Windows menu.</span></span><br><span class="line">    <span class="keyword">set</span> winaltkeys=<span class="keyword">no</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">" EasyAlign</span></span><br><span class="line"><span class="comment">" Start interactive EasyAlign in visual mode (e.g. vipga)</span></span><br><span class="line"><span class="keyword">xmap</span> ga <span class="symbol">&lt;Plug&gt;</span>(EasyAlign)</span><br><span class="line"></span><br><span class="line"><span class="comment">" Start interactive EasyAlign for a motion/text object (e.g. gaip)</span></span><br><span class="line"><span class="keyword">nmap</span> ga <span class="symbol">&lt;Plug&gt;</span>(EasyAlign)</span><br><span class="line"></span><br><span class="line"><span class="comment">" Auto-paris fly mode</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:AutoPairsFlyMode</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">" Easy search the select content</span></span><br><span class="line"><span class="keyword">vnoremap</span> // <span class="keyword">y</span>/<span class="symbol">&lt;c-r&gt;</span><span class="comment">"&lt;cr&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">" ctrlp ignore</span></span><br><span class="line"><span class="comment">" let g:ctrlp_custom_ignore = '\v[\/](node_modules|target|dist)|(\.(swp|ico|git|svn))$'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">" Comment with one Space</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:NERDSpaceDelims</span>=<span class="number">1</span></span><br><span class="line"><span class="comment">" NERDCommenter for vue settings</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:ft</span> = <span class="string">''</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>! <span class="title">NERDCommenter_before</span><span class="params">()</span></span></span><br><span class="line">  <span class="keyword">if</span> &amp;ft == <span class="string">'vue'</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">g:ft</span> = <span class="string">'vue'</span></span><br><span class="line">    <span class="keyword">let</span> stack = <span class="built_in">synstack</span>(<span class="built_in">line</span>(<span class="string">'.'</span>), <span class="keyword">col</span>(<span class="string">'.'</span>))</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(stack) &gt; <span class="number">0</span></span><br><span class="line">      <span class="keyword">let</span> syn = <span class="built_in">synIDattr</span>((stack)[<span class="number">0</span>], <span class="string">'name'</span>)</span><br><span class="line">      <span class="keyword">if</span> <span class="built_in">len</span>(syn) &gt; <span class="number">0</span></span><br><span class="line">        <span class="keyword">exe</span> <span class="string">'setf '</span> . <span class="keyword">substitute</span>(<span class="built_in">tolower</span>(syn), <span class="string">'^vue_'</span>, <span class="string">''</span>, <span class="string">''</span>)</span><br><span class="line">      <span class="keyword">endif</span></span><br><span class="line">    <span class="keyword">endif</span></span><br><span class="line">  <span class="keyword">endif</span></span><br><span class="line"><span class="keyword">endfunction</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>! <span class="title">NERDCommenter_after</span><span class="params">()</span></span></span><br><span class="line">  <span class="keyword">if</span> <span class="variable">g:ft</span> == <span class="string">'vue'</span></span><br><span class="line">    <span class="keyword">setf</span> vue</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">g:ft</span> = <span class="string">''</span></span><br><span class="line">  <span class="keyword">endif</span></span><br><span class="line"><span class="keyword">endfunction</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:vue_disable_pre_processors</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">" Vim general</span></span><br><span class="line"><span class="keyword">set</span> nofoldenable</span><br><span class="line"></span><br><span class="line"><span class="comment">" ==================== Easy Motion ====================</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:EasyMotion_do_mapping</span> = <span class="number">0</span> <span class="comment">" Disable default mappings</span></span><br><span class="line"></span><br><span class="line"><span class="comment">" Jump to anywhere you want with minimal keystrokes, with just one key binding.</span></span><br><span class="line"><span class="comment">" `s&#123;char&#125;&#123;label&#125;`</span></span><br><span class="line"><span class="comment">" nmap &lt;space&gt; &lt;Plug&gt;(easymotion-overwin-f)</span></span><br><span class="line"><span class="comment">" or</span></span><br><span class="line"><span class="comment">" `s&#123;char&#125;&#123;char&#125;&#123;label&#125;`</span></span><br><span class="line"><span class="comment">" Need one more keystroke, but on average, it may be more comfortable.</span></span><br><span class="line"><span class="keyword">nmap</span> <span class="symbol">&lt;space&gt;</span>s <span class="symbol">&lt;Plug&gt;</span>(easymotion-overwin-f2)</span><br><span class="line"></span><br><span class="line"><span class="comment">" &lt;space&gt;f&#123;char&#125; to move to &#123;char&#125;</span></span><br><span class="line"><span class="keyword">map</span>  <span class="symbol">&lt;space&gt;</span><span class="keyword">f</span> <span class="symbol">&lt;Plug&gt;</span>(easymotion-<span class="keyword">bd</span>-<span class="keyword">f</span>)</span><br><span class="line"><span class="keyword">nmap</span> <span class="symbol">&lt;space&gt;</span><span class="keyword">f</span> <span class="symbol">&lt;Plug&gt;</span>(easymotion-overwin-<span class="keyword">f</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">" Move to line</span></span><br><span class="line"><span class="keyword">map</span> <span class="symbol">&lt;space&gt;</span>L <span class="symbol">&lt;Plug&gt;</span>(easymotion-<span class="keyword">bd</span>-jk)</span><br><span class="line"><span class="keyword">nmap</span> <span class="symbol">&lt;space&gt;</span>L <span class="symbol">&lt;Plug&gt;</span>(easymotion-overwin-<span class="built_in">line</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">" Move to word</span></span><br><span class="line"><span class="keyword">map</span>  <span class="symbol">&lt;space&gt;</span><span class="keyword">w</span> <span class="symbol">&lt;Plug&gt;</span>(easymotion-<span class="keyword">bd</span>-<span class="keyword">w</span>)</span><br><span class="line"><span class="keyword">nmap</span> <span class="symbol">&lt;space&gt;</span><span class="keyword">w</span> <span class="symbol">&lt;Plug&gt;</span>(easymotion-overwin-<span class="keyword">w</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">" Turn on case insensitive feature</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">g:EasyMotion_smartcase</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">" JK motions: Line motions</span></span><br><span class="line"><span class="keyword">map</span> <span class="symbol">&lt;space&gt;</span><span class="keyword">j</span> <span class="symbol">&lt;Plug&gt;</span>(easymotion-<span class="keyword">j</span>)</span><br><span class="line"><span class="keyword">map</span> <span class="symbol">&lt;space&gt;</span><span class="keyword">k</span> <span class="symbol">&lt;Plug&gt;</span>(easymotion-<span class="keyword">k</span>)</span><br><span class="line"><span class="comment">" ==================== Easy Motion ====================</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"Keep search pattern at the center of the screen."</span></span><br><span class="line"><span class="keyword">nnoremap</span> <span class="symbol">&lt;silent&gt;</span> n nzz</span><br><span class="line"><span class="keyword">nnoremap</span> <span class="symbol">&lt;silent&gt;</span> <span class="keyword">N</span> Nzz</span><br><span class="line"><span class="keyword">nnoremap</span> <span class="symbol">&lt;silent&gt;</span> * *zz</span><br><span class="line"><span class="keyword">nnoremap</span> <span class="symbol">&lt;silent&gt;</span> # #zz</span><br><span class="line"><span class="keyword">nnoremap</span> <span class="symbol">&lt;silent&gt;</span> g* g*zz</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;!-- toc --&gt;
&lt;!-- Description to show on index here  --&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Vim - the ubiquitous text editor&lt;/strong&gt;&lt;br&gt;Vim is a highly configurable text editor for efficiently creating and changing any kind of text. It is included as “vi” with most UNIX systems and with Apple OS X.&lt;br&gt;Vim 是一个可用于高效率创建或者编辑任意类型文本的高度定制化的文本编辑。它以”vi”命令存在于在大多数的UNIX 操作系统以及Apple OS X 中。&lt;/p&gt;
&lt;p align=&quot;right&quot;&gt;— &lt;a href=&quot;https://www.vim.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.vim.org/&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Vim 作为一个“上古”编辑器，它提供了很多很神奇高效的特性，以至于在现代编辑器/强大的IDE的选择之中有一席之地。&lt;br&gt;Vim有一个很合我心意的特性，在使用它的时候，完全不需要使用鼠标，眼睛看到哪就可以编辑哪，现在能支持Vim特性的地方我都安装上了对应的插件，例如Chrome的插件：Vimium, Idea的插件：Ideavim。&lt;br&gt;
    
    </summary>
    
      <category term="Tools" scheme="https://blog.stark-x.cn/categories/Tools/"/>
    
    
      <category term="Vim" scheme="https://blog.stark-x.cn/tags/Vim/"/>
    
      <category term="Coding" scheme="https://blog.stark-x.cn/tags/Coding/"/>
    
  </entry>
  
  <entry>
    <title>使用 kolla-ansible 部署 OpenStack</title>
    <link href="https://blog.stark-x.cn/2018/08/01/Use-kolla-ansible-deploy-OpenStack/"/>
    <id>https://blog.stark-x.cn/2018/08/01/Use-kolla-ansible-deploy-OpenStack/</id>
    <published>2018-08-01T02:46:54.000Z</published>
    <updated>2018-08-31T02:42:26.953Z</updated>
    
    <content type="html"><![CDATA[<p>使用<code>kolla-ansible</code>部署”all-in-one” OpenStack Queens<br><!-- toc --><br><!-- Description to show on index here  --></p><h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><p>此教程在MacOS上完成，在开始前请预留8Gb内存，30G的磁盘空间，因为要下载相关资源文件，最好搭好梯子。</p><h2 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h2><ul><li><a href="https://www.virtualbox.org/wiki/Downloads" target="_blank" rel="noopener">VirtualBox</a></li><li><a href="https://www.vagrantup.com/" target="_blank" rel="noopener">Vagrant</a></li></ul><p>MacOS上强烈推荐使用<a href="https://brew.sh/index_zh-cn" target="_blank" rel="noopener">Homebrew</a>, 然后使用命令<code>brew tap caskroom/cask</code>安装cask，安装完毕之后，安装上述两个Application只需要使用<code>brew cask install virtualbox vagrant</code>即可快速完成解压、安装等一系列人手操作。</p><a id="more"></a><h1 id="下载Vagrantfile并启动"><a href="#下载Vagrantfile并启动" class="headerlink" title="下载Vagrantfile并启动"></a>下载Vagrantfile并启动</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span></span><br><span class="line">mkdir -p workspace/learning/openstack</span><br><span class="line"><span class="built_in">cd</span> workspace/learning/openstack</span><br><span class="line">curl -sS https://gist.github.com/Stark-X/d1e7ce4b8fcd2ea775249978237939f1</span><br><span class="line">time vagrant up</span><br></pre></td></tr></table></figure><p>Vagrantfile使用了CentOS 7 作为VM的image，还包含了一些初始化操作，如安装docker，花费时间视主机性能、网络而定。<br><small>* <em>作为参考，笔者使用的15版MBP(2.2Ghz i7 cpu, 16Gb mem, macOS High Sierra v10.13.6)，已有CentOS镜像缓存的情况下，用了10分钟。</em></small></p><h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><h2 id="globals-yml"><a href="#globals-yml" class="headerlink" title="globals.yml"></a>globals.yml</h2><p>位置：/etc/kolla/globals.yml<br>这个文件是kolla-ansible部署的关键配置文件，网络、组件开启关闭等所有的配置都由此文件决定。<br>以下几个配置只是其中一部分，OpenStack还有更多的参数可以改变，具体查看官方文档。<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Valid options are ['centos', 'debian', 'oraclelinux', 'rhel', 'ubuntu']</span></span><br><span class="line"><span class="attr">kolla_base_distro:</span> <span class="string">"centos"</span></span><br><span class="line"><span class="comment"># Valid options are [ binary, source ]</span></span><br><span class="line"><span class="attr">kolla_install_type:</span> <span class="string">"source"</span></span><br><span class="line"><span class="comment"># Valid option is Docker repository tag</span></span><br><span class="line"><span class="attr">openstack_release:</span> <span class="string">"queens"</span></span><br><span class="line"><span class="attr">enable_haproxy:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">network_interface:</span> <span class="string">eth0</span></span><br><span class="line"><span class="attr">network_external_interface:</span> <span class="string">eth1</span></span><br><span class="line"><span class="attr">kolla_internal_vip_address:</span> <span class="number">10.0</span><span class="number">.2</span><span class="number">.15</span></span><br></pre></td></tr></table></figure></p><h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><h2 id="部署前检查"><a href="#部署前检查" class="headerlink" title="部署前检查"></a>部署前检查</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启调试模式的输出回显，便于查看日志</span></span><br><span class="line"><span class="comment"># ref: https://github.com/ansible/ansible/issues/27078</span></span><br><span class="line"><span class="built_in">export</span> ANSIBLE_STDOUT_CALLBACK=debug</span><br><span class="line">sudo kolla-ansible prechecks -i all-in-one</span><br></pre></td></tr></table></figure><p>这个步骤会检查配置文件设置是否可用，实际上是底层调用了ansible-playbook执行了一系列的操作。</p><h3 id="可能会遇到的问题："><a href="#可能会遇到的问题：" class="headerlink" title="可能会遇到的问题："></a>可能会遇到的问题：</h3><h4 id="Error-Hostname-has-to-resolve-to-IP-address-of-api-interface"><a href="#Error-Hostname-has-to-resolve-to-IP-address-of-api-interface" class="headerlink" title="Error: Hostname has to resolve to IP address of api_interface"></a>Error: Hostname has to resolve to IP address of api_interface</h4><p>检查/etc/hosts文件里面的主机名是否为127.0.0.1，更新”kolla_internal_vip_address”在globals.yml文件里的值。</p><h4 id="TASK-haproxy-Checking-if-kolla-internal-vip-address-and-kolla-external-vip-address-are-not-pingable-from-any-node-failed"><a href="#TASK-haproxy-Checking-if-kolla-internal-vip-address-and-kolla-external-vip-address-are-not-pingable-from-any-node-failed" class="headerlink" title="TASK [haproxy : Checking if kolla_internal_vip_address and kolla_external_vip_address are not pingable from any node] failed"></a>TASK [haproxy : Checking if kolla_internal_vip_address and kolla_external_vip_address are not pingable from any node] failed</h4><p>因为部署为”all_in_one”，不需要”HA Proxy”，编辑globals.yml，去掉”enable_haproxy”的注释，并把值改为”no”</p><h2 id="部署-1"><a href="#部署-1" class="headerlink" title="部署"></a>部署</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo kolla-ansible deploy -i all-in-one</span><br></pre></td></tr></table></figure><p>部署时间与网络状况挂钩，globals.yml中<code>enable_*</code>为yes的组件越多，时间越长，另外，第一次部署会拉取需要的Docker镜像，可自行架设私有镜像仓库，更改docker配置使用私有镜像仓库，加快部署速度。</p><h2 id="生成命令行控制文件"><a href="#生成命令行控制文件" class="headerlink" title="生成命令行控制文件"></a>生成命令行控制文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo kolla-ansible post-deploy -i all-in-one</span><br><span class="line"><span class="comment"># 加载环境信息</span></span><br><span class="line">. /etc/kolla/admin-openrc.sh</span><br></pre></td></tr></table></figure><p>执行完毕后，/etc/kolla/admin-openrc.sh 会被生成，使用<code>cat</code>命令可以查看到其中的环境信息，这些信息会被openstack client用于操作OpenStack。</p><h1 id="Have-fun"><a href="#Have-fun" class="headerlink" title="Have fun"></a>Have fun</h1><h2 id="初始化demo环境"><a href="#初始化demo环境" class="headerlink" title="初始化demo环境"></a>初始化demo环境</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建虚拟网络，创建flavor，上传模板等</span></span><br><span class="line">bash /usr/share/kolla-ansible/init-runonce</span><br></pre></td></tr></table></figure><p>执行完毕后，提示用以下命令创建一个demo实例。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">openstack server create \\</span><br><span class="line">    --image *** \\</span><br><span class="line">    --flavor m1.tiny \\</span><br><span class="line">    --key-name mykey \\</span><br><span class="line">    --nic net-id=*** \\</span><br><span class="line">    demo1</span><br></pre></td></tr></table></figure></p><p>创建完毕后，执行<code>openstack console url show demo1</code>查看在线控制台的URL，可通过noVNC连接到实例的shell。<br><small>*<em>在virtualbox设置nat端口映射</em></small><br>或者在虚拟机内执行命令<code>sudo ip netns exec [NAME] ssh cirros@&lt;ip&gt;</code>切换network namespace，ssh到目标实例。<br>另外，类似<code>docker logs &lt;container_name&gt;</code>，我们可执行命令<code>openstack console log show demo1</code>查看实例的日志。</p><h2 id="登录Admin"><a href="#登录Admin" class="headerlink" title="登录Admin"></a>登录Admin</h2><h3 id="获取密码"><a href="#获取密码" class="headerlink" title="获取密码"></a>获取密码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep keystone_admin_password /etc/kolla/passwords.yml</span><br></pre></td></tr></table></figure><h3 id="登录Admin-1"><a href="#登录Admin-1" class="headerlink" title="登录Admin"></a>登录Admin</h3><p>Url: <a href="http://localhost:8080/auth/login/" target="_blank" rel="noopener">http://localhost:8080/auth/login/</a><br>User: admin<br>Password: ***<br><small>*<em>在virtualbox设置nat端口映射</em></small></p><h1 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h1><h2 id="修正错误的配置"><a href="#修正错误的配置" class="headerlink" title="修正错误的配置"></a>修正错误的配置</h2><p>若发现配置错误，需要重新部署，可选择使用以下工具清理环境。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bash /usr/share/kolla-ansible/tools/stop-containers</span><br><span class="line">bash /usr/share/kolla-ansible/tools/cleanup-containers</span><br><span class="line">bash /usr/share/kolla-ansible/tools/cleanup-host</span><br><span class="line">bash /usr/share/kolla-ansible/tools/cleanup-images</span><br><span class="line"><span class="comment"># Or</span></span><br><span class="line">sudo  kolla-ansible destroy -i all-in-one --yes-i-really-really-mean-it &amp;&amp; kolla-ansible deploy -i all-in-one</span><br></pre></td></tr></table></figure></p><h2 id="设定的IP无法访问"><a href="#设定的IP无法访问" class="headerlink" title="设定的IP无法访问"></a>设定的IP无法访问</h2><p>原本宿主机、虚拟机之间可通过192.168.56.101通讯，部署完成后，无法继续通讯了，这是因为Neutron接管了网络，放置到了不同的namespace，可通过<code>ip netns</code>看到两个新的network namespace，使用命令<code>ip netns exec [NAME] ping &lt;ip&gt;</code>验证。</p><h2 id="OpenStack-Client相关命令"><a href="#OpenStack-Client相关命令" class="headerlink" title="OpenStack Client相关命令"></a>OpenStack Client相关命令</h2><p>以下列出部分OpenStack client的命令，可使用<code>openstack [command] help</code>查看相关的帮助信息。</p><ul><li>openstack flavor list</li><li>openstack server list</li><li>openstack server show [SERVER_NAME]</li><li>… </li></ul><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li>[使用Kolla-Ansible在CentOS 7单节点上部署OpenStack Pike] <a href="https://blog.csdn.net/yan7895566/article/details/79645774" target="_blank" rel="noopener">https://blog.csdn.net/yan7895566/article/details/79645774</a></li><li>[利用kolla快速搭建openstack-ocata单节点] <a href="https://www.lijiawang.org/posts/kolla-openstack-ocata.html" target="_blank" rel="noopener">https://www.lijiawang.org/posts/kolla-openstack-ocata.html</a></li><li>[CentOS7单节点部署OpenStack-Pike(使用kolla-ansible)] <a href="https://blog.csdn.net/persistvonyao/article/details/80229602#5deploy%E6%97%B6%E6%8A%A5%E9%94%99-please-enable-at-least-one-backend-when-enabling-cinder" target="_blank" rel="noopener">https://blog.csdn.net/persistvonyao/article/details/80229602#5deploy%E6%97%B6%E6%8A%A5%E9%94%99-please-enable-at-least-one-backend-when-enabling-cinder</a></li><li>[使用kolla快速部署openstack all-in-one环境] <a href="https://www.sunmite.com/openstack/use-kolla-deploy-openstack-all-in-one.html" target="_blank" rel="noopener">https://www.sunmite.com/openstack/use-kolla-deploy-openstack-all-in-one.html</a></li><li>[kolla-ansible Quick Start] <a href="https://docs.openstack.org/kolla-ansible/latest/user/quickstart.html" target="_blank" rel="noopener">https://docs.openstack.org/kolla-ansible/latest/user/quickstart.html</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;使用&lt;code&gt;kolla-ansible&lt;/code&gt;部署”all-in-one” OpenStack Queens&lt;br&gt;&lt;!-- toc --&gt;&lt;br&gt;&lt;!-- Description to show on index here  --&gt;&lt;/p&gt;
&lt;h1 id=&quot;准备&quot;&gt;&lt;a href=&quot;#准备&quot; class=&quot;headerlink&quot; title=&quot;准备&quot;&gt;&lt;/a&gt;准备&lt;/h1&gt;&lt;p&gt;此教程在MacOS上完成，在开始前请预留8Gb内存，30G的磁盘空间，因为要下载相关资源文件，最好搭好梯子。&lt;/p&gt;
&lt;h2 id=&quot;安装环境&quot;&gt;&lt;a href=&quot;#安装环境&quot; class=&quot;headerlink&quot; title=&quot;安装环境&quot;&gt;&lt;/a&gt;安装环境&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.virtualbox.org/wiki/Downloads&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;VirtualBox&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.vagrantup.com/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Vagrant&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;MacOS上强烈推荐使用&lt;a href=&quot;https://brew.sh/index_zh-cn&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Homebrew&lt;/a&gt;, 然后使用命令&lt;code&gt;brew tap caskroom/cask&lt;/code&gt;安装cask，安装完毕之后，安装上述两个Application只需要使用&lt;code&gt;brew cask install virtualbox vagrant&lt;/code&gt;即可快速完成解压、安装等一系列人手操作。&lt;/p&gt;
    
    </summary>
    
      <category term="Solutions" scheme="https://blog.stark-x.cn/categories/Solutions/"/>
    
    
      <category term="Cloud" scheme="https://blog.stark-x.cn/tags/Cloud/"/>
    
      <category term="OpenStack" scheme="https://blog.stark-x.cn/tags/OpenStack/"/>
    
      <category term="Ops" scheme="https://blog.stark-x.cn/tags/Ops/"/>
    
  </entry>
  
</feed>
